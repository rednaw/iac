name: IAC Tests

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  setup:
    name: Run all tests
    runs-on: ubuntu-latest
    steps:
      - name: Check SOPS key availability
        env:
          SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
        run: |
          if [ -z "$SOPS_AGE_KEY" ]; then
            echo "Error: SOPS_AGE_KEY secret is not configured"
            exit 1
          fi

  terraform-security:
    name: Terraform Security (tfsec)
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Setup tools
        uses: ./.github/actions/setup-iac-tools
        with:
          install_tfsec: 'true'
      - name: Run Terraform security scan
        run: task test:terraform:security

  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Setup tools
        uses: ./.github/actions/setup-iac-tools
        with:
          install_python: 'true'
          install_terraform: 'true'
          install_sops: 'true'
          install_age: 'true'
          setup_sops_key: 'true'
          sops_age_key: ${{ secrets.SOPS_AGE_KEY }}
      - name: Run Terraform validation
        run: task test:terraform:validate

  ansible-lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Setup tools
        uses: ./.github/actions/setup-iac-tools
        with:
          install_python: 'true'
          install_ansible: 'true'
          install_ansible_lint: 'true'
          install_ansible_collections: 'true'
      - name: Run Ansible lint
        run: task test:ansible:lint

  ansible-syntax:
    name: Ansible Syntax
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Setup tools
        uses: ./.github/actions/setup-iac-tools
        with:
          install_ansible: 'true'
          install_ansible_collections: 'true'
      - name: Run Ansible syntax check
        run: task test:ansible:syntax

  taskfiles:
    name: Taskfile Validation
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Setup tools
        uses: ./.github/actions/setup-iac-tools
        with:
          install_python: 'true'
          install_shellcheck: 'true'
      - name: Run Taskfile validation
        run: task test:taskfiles
