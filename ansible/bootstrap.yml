---
# Bootstrap playbook: prepare ubuntu user
# Runs as root (via Hetzner SSH key) and ONLY:
# - Ensures ubuntu user exists
# - Ensures ubuntu has a home, sudo, and SSH authorized_keys

- name: Bootstrap ubuntu user and SSH access
  hosts: all
  remote_user: root
  become: yes
  vars:
    ansible_python_interpreter: /usr/bin/python3

  pre_tasks:
    - name: Decrypt and load infrastructure secrets
      ansible.builtin.import_tasks: tasks/secrets.yml

  tasks:
    - name: Ensure Ansible remote_tmp directory exists with correct permissions
      ansible.builtin.file:
        path: /root/.ansible/tmp
        state: directory
        mode: '1777'
        owner: root
        group: root

    - name: Ensure ubuntu user exists with home and sudo
      ansible.builtin.user:
        name: ubuntu
        shell: /bin/bash
        create_home: yes
        groups: sudo
        append: yes

    - name: Manage SSH authorized keys (using shared task)
      ansible.builtin.import_tasks: tasks/authorized-keys.yml

    - name: Configure passwordless sudo with enhanced logging for ubuntu user
      ansible.builtin.template:
        src: sudoers-ubuntu.j2
        dest: /etc/sudoers.d/90-ubuntu-sudo
        mode: '0440'
        validate: 'visudo -cf %s'
        backup: yes
