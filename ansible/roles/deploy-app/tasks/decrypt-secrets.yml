---
# Decrypt application secrets from env.enc
#
# Inputs:
#   app_root: Path to app directory containing env.enc
#
# Outputs:
#   app_secrets_file: Stat result for env.enc
#   decrypted_app_secrets: Decrypted secrets content (if env.enc exists)

- name: Check if app secrets file exists
  ansible.builtin.stat:
    path: "{{ app_root }}/env.enc"
  register: app_secrets_file
  delegate_to: localhost
  become: false

- name: Decrypt app secrets
  ansible.builtin.shell: |
    SOPS_AGE_KEY_FILE={{ lookup('env', 'HOME') }}/.config/sops/age/keys-{{ lookup('env', 'USER') }}.txt \
    sops -d --input-type yaml --output-type yaml {{ app_root }}/env.enc
  register: decrypted_app_secrets
  changed_when: false
  delegate_to: localhost
  become: false
  when: app_secrets_file.stat.exists
  no_log: true
