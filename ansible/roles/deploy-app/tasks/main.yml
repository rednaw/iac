---
# Deploy application role
#
# This role handles the deployment of containerized applications.
#
# Required variables:
#   registry_name: Registry hostname (e.g. registry.rednaw.nl)
#   image_name: Image name (e.g. rednaw/hello-world)
#   app_root: Absolute path to the app root directory (on localhost)
#   workspace: Workspace name (dev or prod)
#   sha: Image tag / commit SHA to deploy (e.g. abc1234)
#
# Expected files in app_root:
#   docker-compose.yml: Docker Compose service definition
#   env.enc:            (optional) Encrypted environment variables
#
# Requires infrastructure_secrets to be loaded by the calling playbook

# =============================================================================
# Phase 1: Preparation (runs on localhost)
# =============================================================================

- name: Resolve image tag to digest
  ansible.builtin.include_tasks: resolve-image.yml

- name: Decrypt application secrets
  ansible.builtin.include_tasks: decrypt-secrets.yml

# =============================================================================
# Phase 2: Deploy application (runs on target server)
# =============================================================================

- name: Prepare server for deployment
  ansible.builtin.include_tasks: prepare-server.yml

- name: Run application container
  ansible.builtin.include_tasks: run-container.yml

- name: Record deployment metadata
  ansible.builtin.include_tasks: record-deployment.yml
