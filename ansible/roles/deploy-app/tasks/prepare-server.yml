---
# Prepare server for application deployment
#
# Creates deploy directory, copies files, and configures Docker authentication
#
# Inputs:
#   deploy_target: Target path on server
#   app_root: Path to app directory (for docker-compose.yml)
#   image_digest: Full image reference with digest
#   app_secrets_file: Stat result for env.enc
#   decrypted_app_secrets: Decrypted secrets content
#   infrastructure_secrets: Registry credentials

- name: Ensure deploy target directory exists
  ansible.builtin.file:
    path: "{{ deploy_target }}"
    state: directory
    owner: giftfinder
    group: giftfinder
    mode: '0755'

- name: Write decrypted app secrets to .env file on server
  ansible.builtin.copy:
    content: "{{ decrypted_app_secrets.stdout }}"
    dest: "{{ deploy_target }}/.env"
    owner: giftfinder
    group: giftfinder
    mode: '0600'
  when: app_secrets_file.stat.exists
  no_log: true

- name: Ensure IMAGE variable is set in .env file
  ansible.builtin.lineinfile:
    path: "{{ deploy_target }}/.env"
    line: "IMAGE={{ image_digest }}"
    regexp: '^IMAGE='
    owner: giftfinder
    group: giftfinder
    mode: '0600'
    create: true

- name: Copy docker-compose.yml to server
  ansible.builtin.copy:
    src: "{{ app_root }}/docker-compose.yml"
    dest: "{{ deploy_target }}/docker-compose.yml"
    owner: giftfinder
    group: giftfinder
    mode: '0644'

- name: Ensure giftfinder user .docker directory exists
  ansible.builtin.file:
    path: /opt/giftfinder/.docker
    state: directory
    owner: giftfinder
    group: giftfinder
    mode: '0700'

- name: Configure Docker registry auth for giftfinder user
  ansible.builtin.copy:
    content: |
      {
        "auths": {
          "{{ infrastructure_secrets.registry_domain }}": {
            "auth": "{{ (infrastructure_secrets.registry_username + ':' + infrastructure_secrets.registry_password) | b64encode }}"
          }
        }
      }
    dest: /opt/giftfinder/.docker/config.json
    mode: '0600'
    owner: giftfinder
    group: giftfinder
  no_log: true
