---
# Resolve image tag to digest and extract metadata
#
# Inputs:
#   registry_name: Registry hostname
#   image_name: Image name
#   sha: Commit SHA tag
#   app_root: Path to app directory
#
# Outputs:
#   image_ref: Full image reference with tag
#   image_tag: The SHA tag
#   image_digest: Full image reference with digest
#   image_description: From OCI labels
#   image_built_at: From OCI labels
#   app_slug: Application name (from app_root)
#   deploy_target: Target path on server

- name: Construct image reference
  ansible.builtin.set_fact:
    image_ref: "{{ registry_name }}/{{ image_name }}:{{ sha }}"
    image_tag: "{{ sha }}"
  delegate_to: localhost
  become: false

- name: Resolve image tag to digest
  ansible.builtin.command:
    cmd: "crane digest {{ image_ref }}"
  register: crane_digest_result
  delegate_to: localhost
  become: false
  changed_when: false
  failed_when: crane_digest_result.rc != 0 or not crane_digest_result.stdout.startswith('sha256:')

- name: Set image digest fact
  ansible.builtin.set_fact:
    image_digest: "{{ registry_name }}/{{ image_name }}@{{ crane_digest_result.stdout }}"
  delegate_to: localhost
  become: false

- name: Get image configuration for metadata
  ansible.builtin.command:
    cmd: "crane config {{ image_ref }}"
  register: crane_config_result
  delegate_to: localhost
  become: false
  changed_when: false
  failed_when: false

- name: Parse image metadata from labels
  ansible.builtin.set_fact:
    image_description: "{{ (crane_config_result.stdout | from_json).config.Labels['org.opencontainers.image.description'] | default('') }}"
    image_built_at: "{{ (crane_config_result.stdout | from_json).config.Labels['org.opencontainers.image.created'] | default('') }}"
  delegate_to: localhost
  become: false
  when: crane_config_result.rc == 0 and crane_config_result.stdout | length > 0

- name: Set empty metadata if crane config failed
  ansible.builtin.set_fact:
    image_description: ""
    image_built_at: ""
  delegate_to: localhost
  become: false
  when: crane_config_result.rc != 0 or crane_config_result.stdout | length == 0

- name: Derive deploy target from app_root
  ansible.builtin.set_fact:
    app_slug: "{{ app_root | basename }}"
    deploy_target: "/opt/giftfinder/{{ app_root | basename }}"
  delegate_to: localhost
  become: false

- name: Display deployment information
  ansible.builtin.debug:
    msg: |
      Deploying application:
        App: {{ app_slug }}
        Image: {{ image_digest }}
        Tag: {{ image_tag }}
        Description: {{ image_description }}
        Built at: {{ image_built_at }}
        Target: {{ deploy_target }}
  delegate_to: localhost
  become: false
