---
# Decrypt application secrets from .env
#
# Inputs:
#   app_root: Path to app directory containing .env (SOPS-encrypted dotenv)
#
# Outputs:
#   app_secrets_file: Stat result for .env
#   decrypted_app_secrets: Decrypted secrets in dotenv format (if .env exists)

- name: Check for app secrets
  ansible.builtin.stat:
    path: "{{ app_root }}/.env"
  register: app_secrets_file
  delegate_to: localhost
  become: false

- name: Decrypt app secrets
  ansible.builtin.shell: |
    SOPS_AGE_KEY_FILE={{ lookup('env', 'HOME') }}/.config/sops/age/keys.txt \
    sops -d {{ app_root }}/.env
  register: decrypted_app_secrets
  changed_when: false
  delegate_to: localhost
  become: false
  when: app_secrets_file.stat.exists
  no_log: true
