---
# Decrypt application secrets from secrets.yml
#
# Inputs:
#   app_root: Path to app directory containing secrets.yml (SOPS-encrypted YAML)
#
# Outputs:
#   app_secrets_file: Stat result for secrets.yml
#   decrypted_app_secrets: Decrypted secrets in dotenv format (if secrets.yml exists)

- name: Check for app secrets
  ansible.builtin.stat:
    path: "{{ app_root }}/secrets.yml"
  register: app_secrets_file
  delegate_to: localhost
  become: false

- name: Decrypt app secrets (YAML to dotenv)
  ansible.builtin.shell: |
    set -o pipefail
    SOPS_AGE_KEY_FILE={{ lookup('env', 'HOME') }}/.config/sops/age/keys.txt \
    sops -d {{ app_root }}/secrets.yml | yq -o=props | sed 's/ = /=/'
  args:
    executable: /bin/bash
  register: decrypted_app_secrets
  changed_when: false
  delegate_to: localhost
  become: false
  when: app_secrets_file.stat.exists
  no_log: true
