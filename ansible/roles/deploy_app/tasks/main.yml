---
# Deploy application role
#
# This role handles the deployment of containerized applications.
#
# Required variables:
#   registry_name: Registry hostname (e.g. registry.<base_domain>)
#   image_name: Image name (e.g. rednaw/tientje-ketama)
#   app_root: Absolute path to the app root directory (on localhost)
#   workspace: Workspace name (dev or prod)
#   sha: Image tag / commit SHA to deploy (e.g. abc1234)
#
# Expected files in app_root:
#   docker-compose.yml: Docker Compose service definition
#   .env:               SOPS-encrypted environment variables (dotenv format); can be minimal
#
# Requires infrastructure_secrets to be loaded by the calling playbook

# =============================================================================
# Phase 1: Preparation (runs on localhost)
# =============================================================================

- name: Resolve image digest
  ansible.builtin.import_tasks: resolve-image.yml

- name: Decrypt app secrets
  ansible.builtin.import_tasks: decrypt-secrets.yml

# =============================================================================
# Phase 2: Deploy application (runs on target server)
# =============================================================================

- name: Prepare server
  ansible.builtin.import_tasks: prepare-server.yml

- name: Start containers
  ansible.builtin.import_tasks: run-container.yml

- name: Record deployment
  ansible.builtin.import_tasks: record-deployment.yml
