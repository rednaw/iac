---
# Configure deploy user for running Docker applications
# This user is intended for running Docker apps, not administrative tasks

- name: Ensure deploy user exists
  ansible.builtin.user:
    name: deploy
    home: /opt/deploy
    shell: /bin/bash
    groups: docker
    append: false
    create_home: true
    system: false

- name: Ensure deploy home directory exists
  ansible.builtin.file:
    path: /opt/deploy
    state: directory
    owner: deploy
    group: deploy
    mode: '0755'

- name: Ensure deploy .docker directory exists
  ansible.builtin.file:
    path: /opt/deploy/.docker
    state: directory
    owner: deploy
    group: deploy
    mode: '0700'

- name: Ensure Ansible remote_tmp directory exists for deploy user
  ansible.builtin.file:
    path: /tmp/.ansible-deploy
    state: directory
    owner: deploy
    group: deploy
    mode: '0755'

- name: Configure Docker registry auth for deploy user
  ansible.builtin.copy:
    content: |
      {
        "auths": {
          "registry.{{ base_domain }}": {
            "auth": "{{ (infrastructure_secrets.registry_username + ':' + infrastructure_secrets.registry_password) | b64encode }}"
          }
        }
      }
    dest: /opt/deploy/.docker/config.json
    mode: '0600'
    owner: deploy
    group: deploy
  no_log: true
