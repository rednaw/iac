---
# OpenObserve + OTEL Collector (host and Docker metrics). Dashboard import from role files.

- name: Create OpenObserve data directory
  ansible.builtin.file:
    path: /var/lib/openobserve
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create OTEL Collector config directory
  ansible.builtin.file:
    path: /etc/otel-collector
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Generate OpenObserve ingest auth key (base64 email:password)
  ansible.builtin.set_fact:
    openobserve_ingest_auth: "{{ (infrastructure_secrets.openobserve_username + '@observe.local:' + infrastructure_secrets.openobserve_password) | b64encode }}"
  no_log: true

- name: Deploy OTEL Collector config (host metrics -> OpenObserve)
  ansible.builtin.template:
    src: otel-collector-config.yaml.j2
    dest: /etc/otel-collector/config.yaml
    mode: '0644'
    owner: root
    group: root
  notify: Restart OTEL Collector

- name: Ensure OpenObserve network exists
  community.docker.docker_network:
    name: openobserve-network
    driver: bridge
    state: present

- name: Pull OpenObserve image
  community.docker.docker_image:
    name: openobserve/openobserve:latest
    source: pull

- name: Ensure OpenObserve container is running
  community.docker.docker_container:
    name: openobserve
    image: openobserve/openobserve:latest
    state: started
    restart_policy: unless-stopped
    log_driver: json-file
    log_options:
      max-size: "10m"
      max-file: "3"
    env:
      ZO_ROOT_USER_EMAIL: "{{ infrastructure_secrets.openobserve_username }}@observe.local"
      ZO_ROOT_USER_PASSWORD: "{{ infrastructure_secrets.openobserve_password }}"
      ZO_LOCAL_MODE: "true"
      ZO_RETENTION_DAYS: "7"
    ports:
      - "127.0.0.1:5080:5080"
    volumes:
      - /var/lib/openobserve:/data
    networks:
      - name: openobserve-network
      - name: traefik
    healthcheck:
      test: ["CMD", "/openobserve", "view", "-c", "version"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

- name: Pull OpenTelemetry Collector image
  community.docker.docker_image:
    name: otel/opentelemetry-collector-contrib:latest
    source: pull

- name: Ensure OTEL Collector container is running (Linux host metrics + Docker + logs -> OpenObserve)
  community.docker.docker_container:
    name: otel-collector
    image: otel/opentelemetry-collector-contrib:latest
    state: started
    restart_policy: unless-stopped
    log_driver: json-file
    log_options:
      max-size: "10m"
      max-file: "3"
    user: "0"
    command: ["--config=/etc/otelcol/config.yaml"]
    volumes:
      - /etc/otel-collector/config.yaml:/etc/otelcol/config.yaml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Log directories for log collection
      - /var/log/traefik:/var/log/traefik:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/log/syslog:/var/log/syslog:ro
      - /var/log/auth.log:/var/log/auth.log:ro
      - /var/log/fail2ban.log:/var/log/fail2ban.log:ro
    networks:
      - name: openobserve-network
    healthcheck:
      test: ["CMD", "/otelcol-contrib", "--version"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

- name: Wait for OpenObserve API to be ready
  ansible.builtin.uri:
    url: "http://127.0.0.1:5080/api/health"
    method: GET
    status_code: [200, 401]
  register: openobserve_health
  until: openobserve_health.status in [200, 401]
  retries: 10
  delay: 5
  ignore_errors: true

# List returns { "dashboards": [ { "dashboard_id", "title", ... } ] }. Match by title and use dashboard_id for PUT.
# OpenObserve dashboard PUT (update) can return 500 (hash validation issues); we accept it so the playbook does not fail.
- name: Get existing OpenObserve dashboards list
  ansible.builtin.uri:
    url: "http://127.0.0.1:5080/api/default/dashboards"
    method: GET
    headers:
      Authorization: "Basic {{ openobserve_ingest_auth }}"
    status_code: [200]
  register: openobserve_dashboards_list
  when: openobserve_health.status in [200, 401]

# Resolve dashboard id from list (support top-level title/dashboard_id or v8.title/v8.dashboardId)
- name: Set dashboard id by title from list (Host Metrics)
  ansible.builtin.set_fact:
    openobserve_host_id: "{{ item.dashboard_id | default(item.id) | default((item.v8 | default({})).dashboardId) | default('') }}"
  loop: "{{ openobserve_dashboards_list.json.dashboards | default([]) }}"
  when:
    - openobserve_health.status in [200, 401]
    - openobserve_dashboards_list.json is defined
    - (item.title | default((item.v8 | default({})).title) | default('')) == 'Host Metrics'
    - (openobserve_host_id | default('')) == ''
  loop_control:
    label: "Host Metrics"

- name: Set dashboard id by title from list (Docker Container Metrics)
  ansible.builtin.set_fact:
    openobserve_docker_id: "{{ item.dashboard_id | default(item.id) | default((item.v8 | default({})).dashboardId) | default('') }}"
  loop: "{{ openobserve_dashboards_list.json.dashboards | default([]) }}"
  when:
    - openobserve_health.status in [200, 401]
    - openobserve_dashboards_list.json is defined
    - (item.title | default((item.v8 | default({})).title) | default('')) == 'Docker Container Metrics'
    - (openobserve_docker_id | default('')) == ''
  loop_control:
    label: "Docker Container Metrics"

- name: Set dashboard id by title from list (Traefik Metrics)
  ansible.builtin.set_fact:
    openobserve_traefik_id: "{{ item.dashboard_id | default(item.id) | default((item.v8 | default({})).dashboardId) | default('') }}"
  loop: "{{ openobserve_dashboards_list.json.dashboards | default([]) }}"
  when:
    - openobserve_health.status in [200, 401]
    - openobserve_dashboards_list.json is defined
    - (item.title | default((item.v8 | default({})).title) | default('')) == 'Traefik Metrics'
    - (openobserve_traefik_id | default('')) == ''
  loop_control:
    label: "Traefik Metrics"

- name: Ensure Host Metrics dashboard (create or update in place)
  when: openobserve_health.status in [200, 401]
  block:
    - name: Create Host Metrics dashboard
      ansible.builtin.uri:
        url: "http://127.0.0.1:5080/api/default/dashboards"
        method: POST
        headers:
          Authorization: "Basic {{ openobserve_ingest_auth }}"
          Content-Type: "application/json"
        body_format: json
        body: "{{ lookup('file', role_path + '/files/openobserve-host-metrics.json') | from_json }}"
        status_code: [200, 201, 409]
      when: (openobserve_host_id | default('')) == ''
      failed_when: false

    - name: Update Host Metrics dashboard in place
      ansible.builtin.uri:
        url: "http://127.0.0.1:5080/api/default/dashboards/{{ openobserve_host_id }}"
        method: PUT
        headers:
          Authorization: "Basic {{ openobserve_ingest_auth }}"
          Content-Type: "application/json"
        body_format: json
        body: "{{ lookup('file', role_path + '/files/openobserve-host-metrics.json') | from_json }}"
        status_code: [200, 201, 500]
      when: (openobserve_host_id | default('')) != ''
      failed_when: false

- name: Ensure Docker Container Metrics dashboard (create or update in place)
  when: openobserve_health.status in [200, 401]
  block:
    - name: Create Docker Container Metrics dashboard
      ansible.builtin.uri:
        url: "http://127.0.0.1:5080/api/default/dashboards"
        method: POST
        headers:
          Authorization: "Basic {{ openobserve_ingest_auth }}"
          Content-Type: "application/json"
        body_format: json
        body: "{{ lookup('file', role_path + '/files/openobserve-docker-metrics.json') | from_json }}"
        status_code: [200, 201, 409]
      when: (openobserve_docker_id | default('')) == ''
      failed_when: false

    - name: Update Docker Container Metrics dashboard in place
      ansible.builtin.uri:
        url: "http://127.0.0.1:5080/api/default/dashboards/{{ openobserve_docker_id }}"
        method: PUT
        headers:
          Authorization: "Basic {{ openobserve_ingest_auth }}"
          Content-Type: "application/json"
        body_format: json
        body: "{{ lookup('file', role_path + '/files/openobserve-docker-metrics.json') | from_json }}"
        status_code: [200, 201, 500]
      when: (openobserve_docker_id | default('')) != ''
      failed_when: false

- name: Ensure Traefik Metrics dashboard (create or update in place)
  when: openobserve_health.status in [200, 401]
  block:
    - name: Create Traefik Metrics dashboard
      ansible.builtin.uri:
        url: "http://127.0.0.1:5080/api/default/dashboards"
        method: POST
        headers:
          Authorization: "Basic {{ openobserve_ingest_auth }}"
          Content-Type: "application/json"
        body_format: json
        body: "{{ lookup('file', role_path + '/files/openobserve-traefik-metrics.json') | from_json }}"
        status_code: [200, 201, 409]
      when: (openobserve_traefik_id | default('')) == ''
      failed_when: false

    - name: Update Traefik Metrics dashboard in place
      ansible.builtin.uri:
        url: "http://127.0.0.1:5080/api/default/dashboards/{{ openobserve_traefik_id }}"
        method: PUT
        headers:
          Authorization: "Basic {{ openobserve_ingest_auth }}"
          Content-Type: "application/json"
        body_format: json
        body: "{{ lookup('file', role_path + '/files/openobserve-traefik-metrics.json') | from_json }}"
        status_code: [200, 201, 500]
      when: (openobserve_traefik_id | default('')) != ''
      failed_when: false
