---
# Docker Registry v3 installation, configuration and authentication setup

- name: Install apache2-utils for htpasswd
  ansible.builtin.apt:
    name: apache2-utils
    state: present
    update_cache: true

- name: Create registry storage directory
  ansible.builtin.file:
    path: /var/lib/docker-registry
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create registry configuration directory
  ansible.builtin.file:
    path: /etc/docker-registry
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Generate htpasswd file for Traefik
  ansible.builtin.command: >
    htpasswd -Bbn
    {{ infrastructure_secrets.registry_username }}
    {{ infrastructure_secrets.registry_password }}
  register: htpasswd_output
  changed_when: true
  no_log: true

- name: Write htpasswd to Traefik auth directory
  ansible.builtin.copy:
    content: "{{ htpasswd_output.stdout }}\n"
    dest: /etc/traefik/auth/htpasswd
    mode: '0644'
    owner: root
    group: root
  no_log: true

- name: Generate registry config file
  ansible.builtin.template:
    src: registry-config.yml.j2
    dest: /etc/docker-registry/config.yml
    mode: '0644'
    owner: root
    group: root
    backup: true

- name: Ensure Docker config directory exists for ubuntu user
  ansible.builtin.file:
    path: /home/ubuntu/.docker
    state: directory
    mode: '0700'
    owner: ubuntu
    group: ubuntu

- name: Configure Docker registry auth for ubuntu user
  ansible.builtin.copy:
    content: |
      {
        "auths": {
          "{{ infrastructure_secrets.registry_domain }}": {
            "auth": "{{ (infrastructure_secrets.registry_username + ':' + infrastructure_secrets.registry_password) | b64encode }}"
          }
        }
      }
    dest: /home/ubuntu/.docker/config.json
    mode: '0600'
    owner: ubuntu
    group: ubuntu
  no_log: true

- name: Ensure registry network exists
  community.docker.docker_network:
    name: registry-network
    driver: bridge
    state: present

- name: Pull registry image
  community.docker.docker_image:
    name: registry:3
    source: pull

- name: Ensure registry container is running
  community.docker.docker_container:
    name: registry
    image: registry:3
    state: started
    restart_policy: unless-stopped
    ports:
      - "127.0.0.1:5001:5000"
    volumes:
      - /var/lib/docker-registry:/var/lib/registry
      - /etc/docker-registry/config.yml:/etc/distribution/config.yml:ro
    networks:
      - name: registry-network
      - name: traefik
    labels:
      traefik.enable: "true"
      traefik.http.routers.registry.rule: "Host(`registry.{{ base_domain | default('rednaw.nl') }}`)"
      traefik.http.routers.registry.entrypoints: "websecure"
      traefik.http.routers.registry.tls.certresolver: "letsencrypt"
      traefik.http.routers.registry.middlewares: "registry-auth"
      traefik.http.middlewares.registry-auth.basicauth.usersfile: "/etc/traefik/auth/htpasswd"
      traefik.http.services.registry.loadbalancer.server.port: "5000"
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 5000 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
