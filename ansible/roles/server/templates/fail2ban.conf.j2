# Fail2ban jail configuration
#
# Security Note: These rules are tuned to balance security with avoiding false positives.
# Rules are more lenient than typical "paranoid" configurations to prevent blocking
# legitimate users. Monitor fail2ban logs and adjust thresholds if needed.
#
# To check bans: sudo fail2ban-client status <jail-name>
# To unban an IP: sudo fail2ban-client set <jail-name> unbanip <ip-address>

[DEFAULT]
# Default ban time: 1 hour
bantime = 3600
# Look back period: 10 minutes  
findtime = 600
# Email notifications (uncomment and configure if needed)
# destemail = your@email.com
# action = %(action_mwl)s

# AbuseIPDB reporting (reports banned IPs to AbuseIPDB)
# API key is configured from SOPS secrets
# Categories: 18=Brute-Force, 20=Bad Web Bot, 21=Exploited Host, 22=SSH
# See https://www.abuseipdb.com/categories for full list
{% if abuseipdb_api_key | default('') != '' %}
action = %(action_)s
         %(action_abuseipdb)s[abuseipdb_apikey="{{ abuseipdb_api_key }}", abuseipdb_category="18,20,21,22"]
{% else %}
# AbuseIPDB reporting disabled (API key not configured in SOPS)
action = %(action_)s
{% endif %}

# Nginx jails disabled (we use Traefik)
[nginx-http-auth]
enabled = false
[nginx-limit-req]
enabled = false

# SSH brute force protection
[sshd]
enabled = true
port = ssh
logpath = /var/log/auth.log
maxretry = 5
bantime = 3600
findtime = 600

# Traefik: auth failures (dashboard, registry, etc.)
[traefik-auth]
enabled = true
port = http,https
logpath = /var/log/traefik/access.log
maxretry = 6
bantime = 1800
findtime = 600
failregex = ^<HOST> -.*"(GET|POST).*HTTP.*" (401|403) .*$

# Traefik: failed app login attempts (/api/auth/login 401|403) – filter in filter.d/traefik-login-attempts.conf
[traefik-login-attempts]
enabled = true
port = http,https
logpath = /var/log/traefik/access.log
maxretry = 8
bantime = 3600
findtime = 600

# Traefik: repeated 403 Forbidden – filter in filter.d/traefik-forbidden.conf
[traefik-forbidden]
enabled = true
port = http,https
logpath = /var/log/traefik/access.log
maxretry = 5
bantime = 3600
findtime = 600

# Traefik: known bad/scanner paths – filter in filter.d/traefik-badbots.conf
[traefik-badbots]
enabled = true
port = http,https
logpath = /var/log/traefik/access.log
maxretry = 3
bantime = 86400
findtime = 600
