# OTEL Collector
receivers:
  hostmetrics:
    collection_interval: 30s
    scrapers:
      cpu: {}
      disk: {}
      filesystem:
        include_fs_types:
          fs_types:
            - ext4
            - xfs
            - btrfs
          match_type: strict
      load: {}
      memory: {}
      network: {}
  
  # Docker container metrics (CPU, memory, network, health status)
  docker_stats:
    endpoint: "unix:///var/run/docker.sock"
    collection_interval: 30s
    timeout: 5s

  # Prometheus receiver: scrape Traefik metrics
  prometheus:
    config:
      scrape_configs:
        - job_name: 'traefik'
          scrape_interval: 30s
          metrics_path: '/metrics'
          static_configs:
            # Traefik is on openobserve-network, accessible via container name
            - targets: ['traefik:8080']
              labels:
                job: 'traefik'
                instance: 'traefik'

  # Log receivers
  # Traefik access logs
  filelog/traefik:
    include:
      - /var/log/traefik/access.log
    exclude:
      - /var/log/traefik/access.log.*

  # Docker container logs (JSON format)
  filelog/docker:
    include:
      - /var/lib/docker/containers/*/*-json.log
    exclude:
      - /var/lib/docker/containers/*/*-json.log.*
    operators:
      - type: json_parser

  # System logs (syslog)
  filelog/syslog:
    include:
      - /var/log/syslog
    exclude:
      - /var/log/syslog.*

  # Auth logs
  filelog/auth:
    include:
      - /var/log/auth.log
    exclude:
      - /var/log/auth.log.*

  # Fail2ban logs
  filelog/fail2ban:
    include:
      - /var/log/fail2ban.log
    exclude:
      - /var/log/fail2ban.log.*

processors:
  # Minimal redaction: only the most critical secrets that should never be in logs
  # This prevents secrets from ever reaching OpenObserve
  transform/redact_basic:
    log_statements:
      - context: log
        statements:
          # Redact Authorization headers (Bearer tokens, Basic auth, etc.)
          - set(body, replace_all_patterns(body, "(?i)Authorization\\s*:\\s*[^\\s]+", "Authorization: [REDACTED]"))
          # Redact passwords in common formats (password=, pwd=, passwd=)
          - set(body, replace_all_patterns(body, "(?i)(password|pwd|passwd|pass)\\s*[:=]\\s*[^\\s]+", "${1}=[REDACTED]"))
          # Redact JWT tokens (eyJ...)
          - set(body, replace_all_patterns(body, "eyJ[A-Za-z0-9\\-_=]+\\.[A-Za-z0-9\\-_=]+\\.[A-Za-z0-9\\-_=]*", "[JWT_REDACTED]"))
          # Redact API keys in common formats (api_key=, apikey=, etc.)
          - set(body, replace_all_patterns(body, "(?i)(api[_-]?key|apikey|access[_-]?key|secret[_-]?key)\\s*[:=]\\s*[A-Za-z0-9\\-_=]{20,}", "${1}=[REDACTED]"))
          # Redact session tokens/cookies (session=, token=, cookie=)
          - set(body, replace_all_patterns(body, "(?i)(session|token|cookie)\\s*[:=]\\s*[A-Za-z0-9\\-_=]{20,}", "${1}=[REDACTED]"))
          # Redact database connection strings (postgres://user:pass@, mysql://user:pass@)
          - set(body, replace_all_patterns(body, "([a-z]+)://[^:]+:[^@]+@", "${1}://[REDACTED]:[REDACTED]@"))

  # Set stream name per log source
  # OpenObserve creates streams based on resource attributes - using service.name as primary identifier
  resource/traefik:
    attributes:
      - key: service.name
        value: traefik-access
        action: upsert
      - key: log.source
        value: traefik
        action: upsert
  resource/docker:
    attributes:
      - key: service.name
        value: docker-containers
        action: upsert
      - key: log.source
        value: docker
        action: upsert
  resource/syslog:
    attributes:
      - key: service.name
        value: syslog
        action: upsert
      - key: log.source
        value: syslog
        action: upsert
  resource/auth:
    attributes:
      - key: service.name
        value: auth
        action: upsert
      - key: log.source
        value: auth
        action: upsert
  resource/fail2ban:
    attributes:
      - key: service.name
        value: fail2ban
        action: upsert
      - key: log.source
        value: fail2ban
        action: upsert
  batch:
    timeout: 5s
    send_batch_size: 1024

exporters:
  otlp_http:
    endpoint: http://openobserve:5080/api/default
    tls:
      insecure: true
    headers:
      Authorization: "Basic {{ openobserve_ingest_auth }}"

  # Send Traefik metrics via Prometheus remote write so metric names are preserved for PromQL
  prometheusremotewrite:
    endpoint: http://openobserve:5080/api/default/prometheus/api/v1/write
    headers:
      Authorization: "Basic {{ openobserve_ingest_auth }}"

service:
  pipelines:
    # Host + Docker metrics via OTLP
    metrics:
      receivers: [hostmetrics, docker_stats]
      exporters: [otlp_http]
    # Traefik metrics via Prometheus remote write (preserves traefik_* names for dashboard)
    metrics/traefik:
      receivers: [prometheus]
      exporters: [prometheusremotewrite]
    # Logs pipelines: one per source so each gets its own stream in OpenObserve
    logs/traefik:
      receivers: [filelog/traefik]
      processors: [transform/redact_basic, resource/traefik, batch]
      exporters: [otlp_http]
    logs/docker:
      receivers: [filelog/docker]
      processors: [transform/redact_basic, resource/docker, batch]
      exporters: [otlp_http]
    logs/syslog:
      receivers: [filelog/syslog]
      processors: [transform/redact_basic, resource/syslog, batch]
      exporters: [otlp_http]
    logs/auth:
      receivers: [filelog/auth]
      processors: [transform/redact_basic, resource/auth, batch]
      exporters: [otlp_http]
    logs/fail2ban:
      receivers: [filelog/fail2ban]
      processors: [transform/redact_basic, resource/fail2ban, batch]
      exporters: [otlp_http]
