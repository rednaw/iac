# OTEL Collector: host + Docker metrics -> OpenObserve. Auth = Basic (email:password from secrets).

receivers:
  hostmetrics:
    collection_interval: 30s
    scrapers:
      cpu: {}
      disk: {}
      filesystem:
        include_fs_types:
          fs_types:
            - ext4
            - xfs
            - btrfs
          match_type: strict
      load: {}
      memory: {}
      network: {}
  
  # Docker container metrics (CPU, memory, network, health status)
  docker_stats:
    endpoint: "unix:///var/run/docker.sock"
    collection_interval: 30s
    timeout: 5s

  # Prometheus receiver: scrape Traefik metrics
  prometheus:
    config:
      scrape_configs:
        - job_name: 'traefik'
          scrape_interval: 30s
          metrics_path: '/metrics'
          static_configs:
            # Traefik is on openobserve-network, accessible via container name
            - targets: ['traefik:8080']
              labels:
                job: 'traefik'
                instance: 'traefik'

exporters:
  otlp_http:
    endpoint: http://openobserve:5080/api/default
    tls:
      insecure: true
    headers:
      Authorization: "Basic {{ openobserve_ingest_auth }}"

  # Send Traefik metrics via Prometheus remote write so metric names are preserved for PromQL
  prometheusremotewrite:
    endpoint: http://openobserve:5080/api/default/prometheus/api/v1/write
    headers:
      Authorization: "Basic {{ openobserve_ingest_auth }}"

service:
  pipelines:
    # Host + Docker metrics via OTLP
    metrics:
      receivers: [hostmetrics, docker_stats]
      exporters: [otlp_http]
    # Traefik metrics via Prometheus remote write (preserves traefik_* names for dashboard)
    metrics/traefik:
      receivers: [prometheus]
      exporters: [prometheusremotewrite]
