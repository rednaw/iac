# OTEL Collector
receivers:
  hostmetrics:
    collection_interval: 30s
    scrapers:
      cpu: {}
      disk: {}
      filesystem:
        include_fs_types:
          fs_types:
            - ext4
            - xfs
            - btrfs
          match_type: strict
      load: {}
      memory: {}
      network: {}
  
  # Docker container metrics (CPU, memory, network, health status)
  docker_stats:
    endpoint: "unix:///var/run/docker.sock"
    collection_interval: 30s
    timeout: 5s

  # Prometheus receiver: scrape Traefik metrics
  prometheus:
    config:
      scrape_configs:
        - job_name: 'traefik'
          scrape_interval: 30s
          metrics_path: '/metrics'
          static_configs:
            # Traefik is on openobserve-network, accessible via container name
            - targets: ['traefik:8080']
              labels:
                job: 'traefik'
                instance: 'traefik'

  # Log receivers
  # Traefik access logs
  filelog/traefik:
    include:
      - /var/log/traefik/access.log
    exclude:
      - /var/log/traefik/access.log.*

  # Docker container logs (JSON format)
  filelog/docker:
    include:
      - /var/lib/docker/containers/*/*-json.log
    exclude:
      - /var/lib/docker/containers/*/*-json.log.*
    operators:
      - type: json_parser

  # System logs (syslog)
  filelog/syslog:
    include:
      - /var/log/syslog
    exclude:
      - /var/log/syslog.*

  # Auth logs
  filelog/auth:
    include:
      - /var/log/auth.log
    exclude:
      - /var/log/auth.log.*

  # Fail2ban logs
  filelog/fail2ban:
    include:
      - /var/log/fail2ban.log
    exclude:
      - /var/log/fail2ban.log.*

processors:
  # Redact sensitive data in log bodies before sending to OpenObserve (OTTL replace_pattern on log.body.string)
  transform/redact_basic:
    error_mode: ignore
    log_statements:
      - 'replace_pattern(log.body.string, "(?i)Authorization\\s*:\\s*[^\\s]+", "Authorization: [REDACTED]")'
      - 'replace_pattern(log.body.string, "(?i)(password|pwd|passwd|pass)\\s*[:=]\\s*[^\\s]+", "[REDACTED]")'
      - 'replace_pattern(log.body.string, "eyJ[A-Za-z0-9_-]+\\.[A-Za-z0-9_-]+\\.[A-Za-z0-9_-]*", "[JWT_REDACTED]")'
      - 'replace_pattern(log.body.string, "(?i)(api_key|apikey|access_key|secret_key)\\s*[:=]\\s*[A-Za-z0-9_-]{20,}", "[REDACTED]")'
      - 'replace_pattern(log.body.string, "(?i)(session|token|cookie)\\s*[:=]\\s*[A-Za-z0-9_-]{20,}", "[REDACTED]")'
      - 'replace_pattern(log.body.string, "([a-z]+)://[^:]+:[^@]+@", "[REDACTED]://[REDACTED]:[REDACTED]@")'

  # Set stream name per log source
  # OpenObserve creates streams based on resource attributes - using service.name as primary identifier
  resource/traefik:
    attributes:
      - key: service.name
        value: traefik-access
        action: upsert
      - key: log.source
        value: traefik
        action: upsert
  resource/docker:
    attributes:
      - key: service.name
        value: docker-containers
        action: upsert
      - key: log.source
        value: docker
        action: upsert
  resource/syslog:
    attributes:
      - key: service.name
        value: syslog
        action: upsert
      - key: log.source
        value: syslog
        action: upsert
  resource/auth:
    attributes:
      - key: service.name
        value: auth
        action: upsert
      - key: log.source
        value: auth
        action: upsert
  resource/fail2ban:
    attributes:
      - key: service.name
        value: fail2ban
        action: upsert
      - key: log.source
        value: fail2ban
        action: upsert
  batch:
    timeout: 5s
    send_batch_size: 1024

exporters:
  otlp_http:
    endpoint: http://openobserve:5080/api/default
    tls:
      insecure: true
    headers:
      Authorization: "Basic {{ openobserve_ingest_auth }}"

  # Send all metrics via Prometheus remote write (OTLP->Prometheus conversion gives dashboard-ready names)
  prometheusremotewrite:
    endpoint: http://openobserve:5080/api/default/prometheus/api/v1/write
    headers:
      Authorization: "Basic {{ openobserve_ingest_auth }}"

service:
  pipelines:
    # Host + Docker + Traefik metrics: Prometheus remote write (for PromQL/dashboards) and OTLP (OpenObserve native)
    metrics:
      receivers: [hostmetrics, docker_stats, prometheus]
      exporters: [prometheusremotewrite, otlp_http]
    # Logs pipelines: one per source so each gets its own stream in OpenObserve
    logs/traefik:
      receivers: [filelog/traefik]
      processors: [transform/redact_basic, resource/traefik, batch]
      exporters: [otlp_http]
    logs/docker:
      receivers: [filelog/docker]
      processors: [transform/redact_basic, resource/docker, batch]
      exporters: [otlp_http]
    logs/syslog:
      receivers: [filelog/syslog]
      processors: [transform/redact_basic, resource/syslog, batch]
      exporters: [otlp_http]
    logs/auth:
      receivers: [filelog/auth]
      processors: [transform/redact_basic, resource/auth, batch]
      exporters: [otlp_http]
    logs/fail2ban:
      receivers: [filelog/fail2ban]
      processors: [transform/redact_basic, resource/fail2ban, batch]
      exporters: [otlp_http]
