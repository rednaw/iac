---
# Ansible Playbook for Giftfinder Server Configuration
# Complete server setup - idempotent, can be run from scratch

- name: Configure Giftfinder Production Server
  hosts: all
  become: yes

  pre_tasks:
    - name: Remove old server host key from known_hosts (if exists)
      ansible.builtin.command: ssh-keygen -R {{ ansible_host }} -f {{ lookup('env', 'HOME') }}/.ssh/known_hosts
      delegate_to: localhost
      become: no
      changed_when: false
      run_once: true
      failed_when: false
      # noqa: run-once[task]  # Only needs to run once (delegated to localhost)

    - name: Decrypt and load infrastructure secrets
      ansible.builtin.import_tasks: tasks/secrets.yml

  tasks:
    - name: Base system setup
      ansible.builtin.import_tasks: tasks/base.yml

    - name: Manage SSH authorized keys
      ansible.builtin.import_tasks: tasks/authorized-keys.yml

    - name: Unattended upgrades
      ansible.builtin.import_tasks: tasks/unattended-upgrades.yml

    - name: SSH
      ansible.builtin.import_tasks: tasks/ssh.yml

    - name: Nginx
      ansible.builtin.import_tasks: tasks/nginx.yml

    - name: Certbot SSL
      ansible.builtin.import_tasks: tasks/certbot.yml

    - name: Nginx again
      ansible.builtin.import_tasks: tasks/nginx.yml

    - name: Fail2ban
      ansible.builtin.import_tasks: tasks/fail2ban.yml

    - name: Docker
      ansible.builtin.import_tasks: tasks/docker.yml

    - name: Giftfinder User
      ansible.builtin.import_tasks: tasks/giftfinder-user.yml

    - name: Docker Registry
      ansible.builtin.import_tasks: tasks/registry.yml

  handlers:
    - name: Restart sshd
      ansible.builtin.systemd:
        name: ssh
        state: reloaded

    - name: Restart fail2ban
      ansible.builtin.systemd:
        name: fail2ban
        state: restarted

    - name: Restart nginx
      ansible.builtin.systemd:
        name: nginx
        state: restarted

    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: yes
