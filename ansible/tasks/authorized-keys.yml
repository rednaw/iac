---
# Manage SSH authorized keys for ubuntu user
# Reads SSH key IDs from secrets/infrastructure-secrets.yml.enc and fetches public keys from Hetzner Cloud

- name: Ensure .ssh directory exists for ubuntu user
  ansible.builtin.file:
    path: /home/ubuntu/.ssh
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0700'

- name: Fetch SSH public keys from Hetzner Cloud
  ansible.builtin.shell: |
    hcloud ssh-key describe {{ item }} -o format='{{ "{{.PublicKey}}" }}'
  delegate_to: localhost
  become: false
  register: hcloud_keys_result
  loop: "{{ infrastructure_secrets.ssh_keys | default([]) }}"
  changed_when: false
  failed_when: false

- name: Extract SSH public keys
  ansible.builtin.set_fact:
    ssh_public_keys: "{{ hcloud_keys_result.results | selectattr('stdout', 'defined') | map(attribute='stdout') | map('trim') | list }}"

- name: Ensure authorized SSH keys for ubuntu user (from Hetzner Cloud)
  ansible.posix.authorized_key:
    user: ubuntu
    state: present
    key: "{{ item }}"
  loop: "{{ ssh_public_keys | default([]) }}"
  when: 
    - ssh_public_keys is defined
    - ssh_public_keys | length > 0

