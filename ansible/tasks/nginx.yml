---
# Nginx installation and configuration
# Uses domain list from infrastructure_secrets.domains or builds from environment

- name: Extract environment and base domain
  ansible.builtin.set_fact:
    app_environment: "{{ 'dev' if 'dev.' in inventory_hostname else 'prod' }}"
    base_domain: "rednaw.nl"

- name: Set cert_domain to match certbot --cert-name (used for /etc/letsencrypt/live/...)
  ansible.builtin.set_fact:
    cert_domain: "{{ app_environment }}.{{ base_domain }}"

- name: Build domain list for configuration
  ansible.builtin.set_fact:
    domains_to_configure:
      - name: "{{ app_environment }}.{{ base_domain }}"
        template: nginx-primary.nl.j2
      - name: "registry.{{ base_domain }}"
        template: nginx-registry.j2

- name: Check if SAN certificate exists
  ansible.builtin.stat:
    path: /etc/letsencrypt/live/{{ cert_domain }}/fullchain.pem
  register: ssl_cert_stat

- name: Set SSL certificate existence fact
  ansible.builtin.set_fact:
    ssl_certs_exist: "{{ ssl_cert_stat.stat.exists | default(false) | bool }}"

- name: Install Nginx
  ansible.builtin.apt:
    name: nginx
    state: present

- name: Remove default Nginx site if it exists
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/nginx/sites-enabled/default
    - /etc/nginx/sites-available/default

- name: Ensure webroot directory exists for ACME challenges
  ansible.builtin.file:
    path: /var/www/html/.well-known/acme-challenge
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'
    recurse: yes

- name: Copy default nginx welcome page to webroot
  ansible.builtin.copy:
    src: /usr/share/nginx/html/index.html
    dest: /var/www/html/index.html
    owner: www-data
    group: www-data
    mode: '0644'
    remote_src: yes

- name: Remove all existing enabled sites
  ansible.builtin.find:
    paths: /etc/nginx/sites-enabled
    patterns: '*'
  register: enabled_sites
  changed_when: false

- name: Remove all existing enabled sites
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ enabled_sites.files }}"
  when: enabled_sites.files | length > 0

- name: Configure Nginx for all domains
  loop: "{{ domains_to_configure }}"
  ansible.builtin.template:
    src: "{{ item.template }}"
    dest: /etc/nginx/sites-available/{{ item.name }}
    mode: '0644'
    backup: yes
  vars:
    domain_name: "{{ item.name }}"
    cert_domain: "{{ cert_domain }}"
    ssl_certs_exist: "{{ ssl_certs_exist }}"
  notify: Restart nginx

- name: Ensure all newly configured configs are enabled
  loop: "{{ domains_to_configure }}"
  ansible.builtin.file:
    src: /etc/nginx/sites-available/{{ item.name }}
    dest: /etc/nginx/sites-enabled/{{ item.name }}
    state: link

- name: Validate Nginx configuration before restart
  ansible.builtin.command: nginx -t
  changed_when: false
  register: nginx_test
  # noqa: no-handler

- name: Fail if Nginx configuration is invalid
  ansible.builtin.fail:
    msg: "Nginx configuration is invalid. Error: {{ nginx_test.stderr | default(nginx_test.stdout) }}"
  when: nginx_test.rc != 0

- name: Flush handlers to restart nginx (if notified)
  ansible.builtin.meta: flush_handlers

- name: Ensure Nginx is enabled and running
  ansible.builtin.systemd:
    name: nginx
    enabled: yes
    state: started
