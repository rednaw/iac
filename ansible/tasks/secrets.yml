---
# Decrypt and load infrastructure secrets from SOPS-encrypted file
# This task decrypts infrastructure-secrets.yml.enc and loads it into infrastructure_secrets variable

- name: Decrypt infrastructure secrets
  ansible.builtin.shell: |
    SOPS_AGE_KEY_FILE={{ lookup('env', 'HOME') }}/.config/sops/age/keys-{{ lookup('env', 'USER') }}.txt \
    sops -d --input-type yaml --output-type yaml {{ playbook_dir }}/../secrets/infrastructure-secrets.yml.enc
  delegate_to: localhost
  become: false
  register: decrypted_secrets
  changed_when: false
  run_once: true
  # noqa: run-once[task]  # Only needs to decrypt once (delegated to localhost)

- name: Load infrastructure secrets
  ansible.builtin.set_fact:
    infrastructure_secrets: "{{ decrypted_secrets.stdout | from_yaml }}"
  run_once: true
  # noqa: run-once[task]  # Facts are shared across hosts, only needs to run once

