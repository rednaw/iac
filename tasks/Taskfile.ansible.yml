# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:
  install:
    desc: Install Ansible collections
    dir: ansible
    silent: true
    cmds:
      - echo "üì¶ Installing Ansible collections..."
      - ansible-galaxy collection install -r requirements.yml

  deploy:
    desc: "Deploy app (use: task ansible:deploy -- dev or -- prod)"
    dir: ansible
    silent: true
    cmds:
      - |
        WORKSPACE=$(../scripts/validate-workspace.sh ansible run "{{.CLI_ARGS}}")
        INVENTORY_FILE="inventory/$WORKSPACE.ini"
        echo "üîë Preparing known_hosts..."
        task hostkeys:prepare -- "$WORKSPACE"
        echo "‚öôÔ∏è  Running full Ansible playbook for workspace: $WORKSPACE..."
        ansible-playbook -i "$INVENTORY_FILE" site.yml

  bootstrap:
    desc: "One-time bootstrap as root (use: task ansible:bootstrap -- dev or -- prod)"
    dir: ansible
    silent: true
    cmds:
      - |
        WORKSPACE=$(../scripts/validate-workspace.sh ansible bootstrap "{{.CLI_ARGS}}")
        echo "NOTE: This step connects as root using your Hetzner SSH key to set up the ubuntu user."
        HOSTNAME=$(task hostkeys:hostname -- "$WORKSPACE")
        echo "üîë Preparing known_hosts..."
        task hostkeys:prepare -- "$WORKSPACE"
        ansible-playbook -i "${HOSTNAME}," bootstrap.yml

  run:
    desc: "Configure server (use: task ansible:run -- dev or -- prod)"
    dir: ansible
    silent: true
    cmds:
      - |
        WORKSPACE=$(../scripts/validate-workspace.sh ansible run "{{.CLI_ARGS}}")
        INVENTORY_FILE="inventory/$WORKSPACE.ini"
        echo "üîë Preparing known_hosts..."
        task hostkeys:prepare -- "$WORKSPACE"
        echo "‚öôÔ∏è  Running full Ansible playbook for workspace: $WORKSPACE..."
        ansible-playbook -i "$INVENTORY_FILE" site.yml
