# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:
  install:
    desc: Install Ansible collections
    dir: ansible
    silent: true
    cmds:
      - echo "üì¶ Installing Ansible collections..."
      - ansible-galaxy collection install -r requirements.yml

  deploy:
    desc: "Deploy app (use: task ansible:deploy -- dev or -- prod)"
    dir: ansible
    silent: true
    vars:
      WORKSPACE: "{{.CLI_ARGS}}"
    preconditions:
      - sh: '[ -n "{{.WORKSPACE}}" ]'
        msg: "Workspace required. Usage: task ansible:deploy -- <dev|prod>"
      - sh: '[ "{{.WORKSPACE}}" = "dev" ] || [ "{{.WORKSPACE}}" = "prod" ]'
        msg: "Invalid workspace '{{.WORKSPACE}}'. Use: dev or prod"
    cmds:
      - |
        echo "üîë Preparing known_hosts..."
        task hostkeys:prepare -- "{{.WORKSPACE}}"
        echo "‚öôÔ∏è  Running full Ansible playbook for workspace: {{.WORKSPACE}}..."
        ansible-playbook -i "inventory/{{.WORKSPACE}}.ini" playbooks/server.yml

  bootstrap:
    desc: "One-time bootstrap as root (use: task ansible:bootstrap -- dev or -- prod)"
    dir: ansible
    silent: true
    vars:
      WORKSPACE: "{{.CLI_ARGS}}"
    preconditions:
      - sh: '[ -n "{{.WORKSPACE}}" ]'
        msg: "Workspace required. Usage: task ansible:bootstrap -- <dev|prod>"
      - sh: '[ "{{.WORKSPACE}}" = "dev" ] || [ "{{.WORKSPACE}}" = "prod" ]'
        msg: "Invalid workspace '{{.WORKSPACE}}'. Use: dev or prod"
    cmds:
      - |
        echo "NOTE: This step connects as root using your Hetzner SSH key to set up the ubuntu user."
        HOSTNAME=$(task hostkeys:hostname -- "{{.WORKSPACE}}")
        echo "üîë Preparing known_hosts..."
        task hostkeys:prepare -- "{{.WORKSPACE}}"
        ansible-playbook -i "${HOSTNAME}," playbooks/bootstrap.yml

  run:
    desc: "Configure server (use: task ansible:run -- dev or -- prod)"
    dir: ansible
    silent: true
    vars:
      WORKSPACE: "{{.CLI_ARGS}}"
    preconditions:
      - sh: '[ -n "{{.WORKSPACE}}" ]'
        msg: "Workspace required. Usage: task ansible:run -- <dev|prod>"
      - sh: '[ "{{.WORKSPACE}}" = "dev" ] || [ "{{.WORKSPACE}}" = "prod" ]'
        msg: "Invalid workspace '{{.WORKSPACE}}'. Use: dev or prod"
    cmds:
      - |
        echo "üîë Preparing known_hosts..."
        task hostkeys:prepare -- "{{.WORKSPACE}}"
        echo "‚öôÔ∏è  Running full Ansible playbook for workspace: {{.WORKSPACE}}..."
        ansible-playbook -i "inventory/{{.WORKSPACE}}.ini" playbooks/server.yml
