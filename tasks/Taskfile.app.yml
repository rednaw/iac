# yaml-language-server: $schema=https://taskfile.dev/schema.json
#
# Application deployment tasks - include this from your app's Taskfile.yml:
#
#   version: '3'
#   vars:
#     REGISTRY_NAME: registry.example.com
#     IMAGE_NAME: myorg/myapp
#   includes:
#     iac:
#       taskfile: ../iac/tasks/Taskfile.app.yml
#
# Then run: task iac:deploy -- dev abc123
#           task iac:versions -- dev
#
# Secrets: Edit secrets.yml directly in VS Code (SOPS extension decrypts transparently)

version: '3'

vars:
  IAC_ROOT:
    sh: realpath "{{.TASKFILE_DIR}}/.."
  APP_ROOT:
    sh: pwd

tasks:
  default:
    desc: Show available commands
    silent: true
    cmds:
      - |
        echo "Application Deployment"
        echo ""
        echo "Commands:"
        echo "  task iac:deploy   -- <env> <sha>   Deploy a version"
        echo "  task iac:versions -- <env>         List available versions"
        echo ""
        echo "Secrets:"
        echo "  task iac:secrets:init              Initialize .sops.yaml and secrets.yml (one-time)"
        echo "  Then edit secrets.yml in VS Code (SOPS extension handles encryption)"

  deploy:
    desc: "Deploy application (use: task iac:deploy -- <environment> <sha>)"
    silent: true
    requires:
      vars: [REGISTRY_NAME, IMAGE_NAME]
    vars:
      WORKSPACE:
        sh: echo "{{.CLI_ARGS}}" | awk '{print $1}'
      SHA:
        sh: echo "{{.CLI_ARGS}}" | awk '{print $2}'
    preconditions:
      - sh: '[ $(echo "{{.CLI_ARGS}}" | wc -w | tr -d " ") -eq 2 ]'
        msg: "Usage: task iac:deploy -- <environment> <sha>"
      - sh: '[ "{{.WORKSPACE}}" = "dev" ] || [ "{{.WORKSPACE}}" = "prod" ]'
        msg: "Invalid environment '{{.WORKSPACE}}'. Use: dev or prod"
    cmds:
      - |
        # Prepare SSH host keys
        cd "{{.IAC_ROOT}}" && task hostkeys:prepare -- "{{.WORKSPACE}}"
        
        # Run Ansible deployment
        ANSIBLE_CONFIG="{{.IAC_ROOT}}/ansible/ansible.cfg" \
        ansible-playbook \
          -i "{{.IAC_ROOT}}/ansible/inventory/{{.WORKSPACE}}.ini" \
          "{{.IAC_ROOT}}/ansible/playbooks/deploy-app.yml" \
          -e "app_root={{.APP_ROOT}}" \
          -e "workspace={{.WORKSPACE}}" \
          -e "sha={{.SHA}}" \
          -e "registry_name={{.REGISTRY_NAME}}" \
          -e "image_name={{.IMAGE_NAME}}"

  versions:
    desc: "List available versions (use: task iac:versions -- <environment>)"
    silent: true
    requires:
      vars: [IMAGE_NAME]
    vars:
      WORKSPACE: "{{.CLI_ARGS}}"
    preconditions:
      - sh: '[ $(echo "{{.CLI_ARGS}}" | wc -w | tr -d " ") -eq 1 ]'
        msg: "Usage: task iac:versions -- <environment>\nExample: task iac:versions -- dev"
      - sh: '[ "{{.WORKSPACE}}" = "dev" ] || [ "{{.WORKSPACE}}" = "prod" ]'
        msg: "Invalid environment '{{.WORKSPACE}}'. Use: dev or prod"
    cmds:
      - cd "{{.IAC_ROOT}}" && python3 scripts/application_versions.py "{{.WORKSPACE}}" "{{.IMAGE_NAME}}"

  secrets:init:
    desc: "Initialize secrets for this app (one-time setup)"
    silent: true
    cmds:
      - |
        cd "{{.APP_ROOT}}" || exit 1
        
        # Collect recipients from IAC public keys
        RECIPIENTS=""
        for pub in "{{.IAC_ROOT}}/secrets"/sops-key-*.pub; do
          if [ -f "$pub" ]; then
            KEY=$(cat "$pub" | tr -d '\n')
            if [ -z "$RECIPIENTS" ]; then
              RECIPIENTS="$KEY"
            else
              RECIPIENTS="$RECIPIENTS,$KEY"
            fi
          fi
        done
        
        if [ -z "$RECIPIENTS" ]; then
          echo "âŒ No public keys found in {{.IAC_ROOT}}/secrets/"
          echo "   Run: cd {{.IAC_ROOT}} && task secrets:keygen"
          exit 1
        fi
        
        # Generate .sops.yaml if missing
        if [ ! -f .sops.yaml ]; then
          echo "ðŸ”§ Creating .sops.yaml..."
          cat > .sops.yaml << EOF
        creation_rules:
          - path_regex: secrets\.yml$
            age: $RECIPIENTS
        EOF
          echo "âœ… Created .sops.yaml"
        else
          echo "âœ“ .sops.yaml already exists"
        fi
        
        # Create secrets.yml if missing
        if [ ! -f secrets.yml ]; then
          echo "ðŸ“ Creating secrets.yml..."
          printf '%s\n' "# Application secrets (YAML format)" "# Example:" "# DATABASE_URL: postgres://user:pass@host/db" > secrets.yml
          sops --encrypt --in-place secrets.yml
          echo "âœ… Created encrypted secrets.yml"
        else
          echo "âœ“ secrets.yml already exists"
        fi
        
        echo ""
        echo "ðŸ“‹ Next steps:"
        echo "   1. Edit secrets.yml in VS Code (install SOPS extension)"
        echo "   2. git add .sops.yaml secrets.yml && git commit -m 'Add secrets'"
