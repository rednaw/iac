# yaml-language-server: $schema=https://taskfile.dev/schema.json
#
# Application deployment tasks â€” run from IAC devcontainer.
# Three app files (iac.yml, docker-compose.yml, secrets.yml) are mounted at /workspaces/iac/app via APP_HOST_PATH.
# Registry and image come from the app's iac.yml.
#
#   task app:deploy   -- <env> <sha>
#   task app:versions -- <env>
#
# See docs/application-deployment.md.

version: '3'

vars:
  IAC_ROOT:
    sh: realpath "{{.TASKFILE_DIR}}/.."
  APP_ROOT: /workspaces/iac/app

tasks:
  deploy:
    desc: "Deploy application (use: task app:deploy -- <environment> <sha>)"
    silent: true
    vars:
      WORKSPACE:
        sh: echo "{{.CLI_ARGS}}" | awk '{print $1}'
      SHA:
        sh: echo "{{.CLI_ARGS}}" | awk '{print $2}'
    preconditions:
      - sh: '[ $(echo "{{.CLI_ARGS}}" | wc -w | tr -d " ") -eq 2 ]'
        msg: "Usage: task app:deploy -- <environment> <sha>"
      - sh: '[ "{{.WORKSPACE}}" = "dev" ] || [ "{{.WORKSPACE}}" = "prod" ]'
        msg: "Invalid environment '{{.WORKSPACE}}'. Use: dev or prod"
      - sh: test -d "{{.APP_ROOT}}"
        msg: "App not mounted at {{.APP_ROOT}}. Run ./scripts/setup-app-path.sh /path/to/app and reopen the devcontainer."
      - sh: test -f "{{.APP_ROOT}}/iac.yml"
        msg: "App missing iac.yml. Run ./scripts/setup-app-path.sh /path/to/app (app must have iac.yml, docker-compose.yml, secrets.yml)."
      - sh: test -f "{{.APP_ROOT}}/docker-compose.yml"
        msg: "App missing docker-compose.yml. Run ./scripts/setup-app-path.sh /path/to/app."
      - sh: test -f "{{.APP_ROOT}}/secrets.yml"
        msg: "App missing secrets.yml. Each app must have secrets.yml (can be minimal, e.g. {}). Run ./scripts/setup-app-path.sh /path/to/app."
    cmds:
      - |
        REGISTRY_NAME=$(yq -r '.REGISTRY_NAME' "{{.APP_ROOT}}/iac.yml")
        IMAGE_NAME=$(yq -r '.IMAGE_NAME' "{{.APP_ROOT}}/iac.yml")
        # Prepare SSH host keys
        cd "{{.IAC_ROOT}}" && task hostkeys:prepare -- "{{.WORKSPACE}}"
        
        # Run Ansible deployment
        ANSIBLE_CONFIG="{{.IAC_ROOT}}/ansible/ansible.cfg" \
        ansible-playbook \
          -i "{{.IAC_ROOT}}/ansible/inventory/{{.WORKSPACE}}.ini" \
          "{{.IAC_ROOT}}/ansible/playbooks/deploy-app.yml" \
          -e "app_root={{.APP_ROOT}}" \
          -e "workspace={{.WORKSPACE}}" \
          -e "sha={{.SHA}}" \
          -e "registry_name=$REGISTRY_NAME" \
          -e "image_name=$IMAGE_NAME"

  versions:
    desc: "List available versions (use: task app:versions -- <environment>)"
    silent: true
    vars:
      WORKSPACE: "{{.CLI_ARGS}}"
    preconditions:
      - sh: '[ $(echo "{{.CLI_ARGS}}" | wc -w | tr -d " ") -eq 1 ]'
        msg: "Usage: task app:versions -- <environment>\nExample: task app:versions -- dev"
      - sh: '[ "{{.WORKSPACE}}" = "dev" ] || [ "{{.WORKSPACE}}" = "prod" ]'
        msg: "Invalid environment '{{.WORKSPACE}}'. Use: dev or prod"
      - sh: test -d "{{.APP_ROOT}}"
        msg: "App not mounted at {{.APP_ROOT}}. Run ./scripts/setup-app-path.sh /path/to/app and reopen the devcontainer."
      - sh: test -f "{{.APP_ROOT}}/iac.yml"
        msg: "App missing iac.yml. Run ./scripts/setup-app-path.sh /path/to/app."
    cmds:
      - |
        REGISTRY_NAME=$(yq -r '.REGISTRY_NAME' "{{.APP_ROOT}}/iac.yml")
        IMAGE_NAME=$(yq -r '.IMAGE_NAME' "{{.APP_ROOT}}/iac.yml")
        APP_SLUG=$(echo "$IMAGE_NAME" | sed 's|.*/||')
        cd "{{.IAC_ROOT}}" && python3 scripts/application_versions.py "{{.WORKSPACE}}" "$REGISTRY_NAME" "$IMAGE_NAME" "$APP_SLUG"
