# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:
  deploy:
    desc: "Deploy application (use: task application:deploy -- <WORKSPACE> <APP_ROOT> <SHA>)"
    silent: true
    cmds:
      - |
        ARGS="{{.CLI_ARGS}}"
        # shellcheck disable=SC2086
        set -- $ARGS
        if [ $# -ne 3 ]; then
          echo "‚ùå Error: Invalid number of arguments (expected 3, got $#)"
          echo ""
          echo "Usage: task application:deploy -- <WORKSPACE> <APP_ROOT> <SHA>"
          exit 1
        fi
        WORKSPACE="$1"
        APP_ROOT_PATH="$2"
        SHA="$3"
        IAC_REPO="$(pwd)"
        APP_ROOT="$(realpath "$APP_ROOT_PATH" 2>/dev/null || echo "$APP_ROOT_PATH")"
        
        APP_SLUG=$(basename "$APP_ROOT")
        DEPLOY_TARGET="/opt/giftfinder/$APP_SLUG"
        
        echo "üöÄ Deploying application..."
        echo ""
        echo "üîë Preparing known_hosts..."
        task hostkeys:prepare -- "$WORKSPACE"
        (cd "$APP_ROOT" && ANSIBLE_CONFIG="$IAC_REPO/ansible/ansible.cfg" ansible-playbook \
          -i "$IAC_REPO/ansible/inventory/$WORKSPACE.ini" \
          deploy.yml \
          -e "iac_repo_root=$IAC_REPO" \
          -e "app_root=$APP_ROOT" \
          -e "deploy_target=$DEPLOY_TARGET" \
          -e "sha=$SHA")
      - echo ""
      - echo "‚úÖ Deployment completed successfully!"
