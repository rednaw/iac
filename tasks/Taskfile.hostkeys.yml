# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

# Workspace â†’ hostname mapping (single source of truth).
# BASE_DOMAIN is set by devcontainer-setup.sh from secrets.

tasks:
  hostname:
    desc: "Output hostname for workspace (use: task hostkeys:hostname -- dev|prod)"
    silent: true
    vars:
      WORKSPACE: "{{.CLI_ARGS}}"
    preconditions:
      - sh: '[ -n "{{.WORKSPACE}}" ]'
        msg: "Workspace required. Usage: task hostkeys:hostname -- <dev|prod>"
      - sh: '[ "{{.WORKSPACE}}" = "dev" ] || [ "{{.WORKSPACE}}" = "prod" ]'
        msg: "Invalid workspace '{{.WORKSPACE}}'. Use: dev or prod"
      - sh: '[ -n "${BASE_DOMAIN:-}" ]'
        msg: "BASE_DOMAIN must be set by devcontainer (from base_domain in secrets)"
    cmds:
      - |
        case "{{.WORKSPACE}}" in
          dev)  echo "dev.${BASE_DOMAIN}" ;;
          prod) echo "prod.${BASE_DOMAIN}" ;;
        esac

  prepare:
    desc: "Remove host key for workspace from known_hosts (use: task hostkeys:prepare -- dev|prod)"
    silent: true
    vars:
      WORKSPACE: "{{.CLI_ARGS}}"
    preconditions:
      - sh: '[ -n "{{.WORKSPACE}}" ]'
        msg: "Workspace required. Usage: task hostkeys:prepare -- <dev|prod>"
      - sh: '[ "{{.WORKSPACE}}" = "dev" ] || [ "{{.WORKSPACE}}" = "prod" ]'
        msg: "Invalid workspace '{{.WORKSPACE}}'. Use: dev or prod"
      - sh: '[ -n "${BASE_DOMAIN:-}" ]'
        msg: "BASE_DOMAIN must be set by devcontainer (from base_domain in secrets)"
    cmds:
      - |
        case "{{.WORKSPACE}}" in
          dev)  HOSTNAME="dev.${BASE_DOMAIN}" ;;
          prod) HOSTNAME="prod.${BASE_DOMAIN}" ;;
        esac
        # Extract domain by removing workspace prefix (e.g., dev.<base_domain> -> <base_domain>)
        DOMAIN="${HOSTNAME#*.}"
        KEYFILE="${HOME}/.ssh/known_hosts"
        [ ! -f "$KEYFILE" ] && exit 0
        for name in "$HOSTNAME" "$DOMAIN" "[${HOSTNAME}]:22" "[${DOMAIN}]:22"; do
          ssh-keygen -R "$name" -f "$KEYFILE" -q 2>/dev/null || true
        done
