# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

# Workspace â†’ hostname mapping (single source of truth).

tasks:
  hostname:
    desc: "Output hostname for workspace (use: task hostkeys:hostname -- dev|prod)"
    silent: true
    vars:
      WORKSPACE: "{{.CLI_ARGS}}"
    preconditions:
      - sh: '[ -n "{{.WORKSPACE}}" ]'
        msg: "Workspace required. Usage: task hostkeys:hostname -- <dev|prod>"
      - sh: '[ "{{.WORKSPACE}}" = "dev" ] || [ "{{.WORKSPACE}}" = "prod" ]'
        msg: "Invalid workspace '{{.WORKSPACE}}'. Use: dev or prod"
    cmds:
      - |
        case "{{.WORKSPACE}}" in
          dev)  echo "dev.rednaw.nl" ;;
          prod) echo "prod.rednaw.nl" ;;
        esac

  prepare:
    desc: "Remove host key for workspace from known_hosts (use: task hostkeys:prepare -- dev|prod)"
    silent: true
    vars:
      WORKSPACE: "{{.CLI_ARGS}}"
    preconditions:
      - sh: '[ -n "{{.WORKSPACE}}" ]'
        msg: "Workspace required. Usage: task hostkeys:prepare -- <dev|prod>"
      - sh: '[ "{{.WORKSPACE}}" = "dev" ] || [ "{{.WORKSPACE}}" = "prod" ]'
        msg: "Invalid workspace '{{.WORKSPACE}}'. Use: dev or prod"
    cmds:
      - |
        case "{{.WORKSPACE}}" in
          dev)  HOSTNAME="dev.rednaw.nl" ;;
          prod) HOSTNAME="prod.rednaw.nl" ;;
        esac
        # Extract domain by removing workspace prefix (e.g., dev.rednaw.nl -> rednaw.nl)
        DOMAIN="${HOSTNAME#*.}"
        KEYFILE="${HOME}/.ssh/known_hosts"
        [ ! -f "$KEYFILE" ] && exit 0
        # Remove all variants: dev.rednaw.nl, rednaw.nl, [dev.rednaw.nl]:22, [rednaw.nl]:22
        for name in "$HOSTNAME" "$DOMAIN" "[${HOSTNAME}]:22" "[${DOMAIN}]:22"; do
          ssh-keygen -R "$name" -f "$KEYFILE" -q 2>/dev/null || true
        done
