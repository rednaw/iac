# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:
  overview:
    desc: "Show image overview with deployment status (use: task images:overview -- <WORKSPACE> <IMAGE_REPO>)"
    silent: true
    cmds:
      - |
        ARGS="{{.CLI_ARGS}}"
        # shellcheck disable=SC2086
        set -- $ARGS
        if [ $# -ne 2 ]; then
          echo "❌ Error: Invalid number of arguments (expected 2, got $#)"
          echo ""
          echo "Usage: task images:overview -- <WORKSPACE> <IMAGE_REPO>"
          echo "Example: task images:overview -- dev rednaw/hello-world"
          exit 1
        fi
        WORKSPACE="$1"
        IMAGE_REPO="$2"
        REGISTRY="registry.rednaw.nl"
        FULL_REPO="${REGISTRY}/${IMAGE_REPO}"
        
        # Get hostname for workspace
        case "$WORKSPACE" in
          dev)  HOSTNAME="dev.rednaw.nl" ;;
          prod) HOSTNAME="prod.rednaw.nl" ;;
          *)    echo "❌ Error: Invalid workspace '$WORKSPACE'. Use: dev or prod" >&2; exit 1 ;;
        esac
        
        # Read deploy-info.yml from server (app name = last component of image repo)
        APP_NAME=$(basename "$IMAGE_REPO")
        DEPLOYED_DIGEST=""
        if DEPLOY_INFO=$(ssh -o StrictHostKeyChecking=accept-new -o ConnectTimeout=5 -o BatchMode=yes "ubuntu@${HOSTNAME}" "cat /opt/giftfinder/${APP_NAME}/deploy-info.yml 2>/dev/null" 2>/dev/null); then
          # Extract digest from deploy-info.yml (format: digest: sha256:...)
          DEPLOYED_DIGEST=$(echo "$DEPLOY_INFO" | grep -E '^\s*digest:' | sed -E 's/.*digest:\s*(.+)/\1/' | tr -d ' ' || echo "")
        fi
        
        echo "IMAGE: $IMAGE_REPO"
        echo ""
        
        if ! command -v crane >/dev/null 2>&1; then
          echo "❌ Error: 'crane' command not found. Install with: brew install crane"
          exit 1
        fi
        if ! command -v jq >/dev/null 2>&1; then
          echo "❌ Error: 'jq' command not found. Install with: brew install jq"
          exit 1
        fi
        
        TAGS=$(crane ls "$FULL_REPO" 2>/dev/null | sort -r || true)
        if [ -z "$TAGS" ]; then
          echo "  ℹ️  No tags found"
          exit 0
        fi
        
        printf "  %-2s %-16s %-20s %-40s\n" "" "TAG" "CREATED" "DESCRIPTION"
        printf "  %-2s %-16s %-20s %-40s\n" "" "---" "-------" "-----------"
        
        for TAG in $TAGS; do
          TAG_IMAGE="${FULL_REPO}:${TAG}"
          DIGEST=$(crane digest "$TAG_IMAGE" 2>/dev/null || echo "")
          CONFIG=$(crane config "$TAG_IMAGE" 2>/dev/null || true)
          CREATED=""
          DESCRIPTION=""
          if [ -n "$CONFIG" ]; then
            CREATED=$(echo "$CONFIG" | jq -r '.config.Labels["org.opencontainers.image.created"] // ""' | cut -d'+' -f1)
            DESCRIPTION=$(echo "$CONFIG" | jq -r '.config.Labels["org.opencontainers.image.description"] // ""')
          fi
          [ ${#DESCRIPTION} -gt 38 ] && DESCRIPTION="${DESCRIPTION:0:38}"
          
          MARKER=""
          if [ -n "$DEPLOYED_DIGEST" ] && [ -n "$DIGEST" ] && [ "$DIGEST" = "$DEPLOYED_DIGEST" ]; then
            MARKER="→"
          fi
          
          printf "  %-2s %-16s %-20s %-40s\n" \
            "$MARKER" "$TAG" "$CREATED" "$DESCRIPTION"
        done
        echo ""
