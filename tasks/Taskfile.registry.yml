# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:
  map:
    desc: "Show semver -> SHA mapping for a repository (use: task registry:map -- <REPO>)"
    silent: true
    cmds:
      - |
        REPO="{{.CLI_ARGS}}"
        if [ -z "$REPO" ]; then
          echo "‚ùå Error: Repository not specified"
          echo ""
          echo "Usage: task registry:map -- <REPO>"
          echo ""
          echo "Example:"
          echo "  task registry:map -- registry.rednaw.nl/rednaw/hello-world"
          exit 1
        fi
        
        echo "üì¶ Semver ‚Üí SHA mapping for $REPO"
        echo ""
        
        # Get all tags
        ALL_TAGS=$(crane ls "$REPO" 2>/dev/null | sort)
        if [ -z "$ALL_TAGS" ]; then
          echo "‚ùå Error: Failed to list tags or repository is empty"
          echo "üí° Tip: Make sure you're logged in: docker login $(echo $REPO | cut -d/ -f1)"
          exit 1
        fi
        
        # Filter semver tags (MAJOR.MINOR.PATCH format)
        SEMVER_TAGS=$(echo "$ALL_TAGS" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | sort -V)
        
        if [ -z "$SEMVER_TAGS" ]; then
          echo "‚ÑπÔ∏è  No semver tags found"
          exit 0
        fi
        
        # Read OCI annotation from each semver tag's manifest
        printf "%-12s %-12s\n" "SEMVER" "SHA"
        printf "%-12s %-12s\n" "------" "---"
        
        for SEMVER in $SEMVER_TAGS; do
          # Get source SHA from OCI annotation
          SOURCE_SHA=""
          
          # Try crane manifest first (faster)
          if command -v crane >/dev/null 2>&1 && command -v jq >/dev/null 2>&1; then
            MANIFEST_JSON=$(crane manifest "$REPO:$SEMVER" 2>/dev/null)
            if [ -n "$MANIFEST_JSON" ]; then
              # OCI annotations are in .annotations or .config.annotations
              SOURCE_SHA=$(echo "$MANIFEST_JSON" | jq -r '.annotations."org.rednaw.source-sha" // .config.annotations."org.rednaw.source-sha" // empty' 2>/dev/null)
            fi
          fi
          
          # Fallback to docker manifest inspect
          if [ -z "$SOURCE_SHA" ] && command -v docker >/dev/null 2>&1 && command -v jq >/dev/null 2>&1; then
            MANIFEST=$(docker manifest inspect "$REPO:$SEMVER" 2>/dev/null)
            if [ -n "$MANIFEST" ]; then
              SOURCE_SHA=$(echo "$MANIFEST" | jq -r '.annotations."org.rednaw.source-sha" // .config.annotations."org.rednaw.source-sha" // empty' 2>/dev/null)
            fi
          fi
          
          if [ -n "$SOURCE_SHA" ] && [ "$SOURCE_SHA" != "null" ]; then
            printf "%-12s %-12s\n" "$SEMVER" "$SOURCE_SHA"
          else
            printf "%-12s %-12s\n" "$SEMVER" "(no annotation)"
          fi
        done
  
  tags:
    desc: "Show all tags grouped by type (use: task registry:tags -- <REPO>)"
    silent: true
    cmds:
      - |
        REPO="{{.CLI_ARGS}}"
        if [ -z "$REPO" ]; then
          echo "‚ùå Error: Repository not specified"
          echo ""
          echo "Usage: task registry:tags -- <REPO>"
          echo ""
          echo "Example:"
          echo "  task registry:tags -- registry.rednaw.nl/rednaw/hello-world"
          exit 1
        fi
        
        echo "üì¶ Tags for $REPO"
        echo ""
        
        # Get all tags
        ALL_TAGS=$(crane ls "$REPO" 2>/dev/null | sort)
        if [ -z "$ALL_TAGS" ]; then
          echo "‚ùå Error: Failed to list tags or repository is empty"
          exit 1
        fi
        
        # Group tags
        SEMVER_TAGS=$(echo "$ALL_TAGS" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | sort -V)
        SHA_TAGS=$(echo "$ALL_TAGS" | grep -E '^[0-9a-f]{7}$' | sort)
        OTHER_TAGS=$(echo "$ALL_TAGS" | grep -vE '^[0-9]+\.[0-9]+\.[0-9]+$' | grep -vE '^[0-9a-f]{7}$' | sort)
        
        if [ -n "$SEMVER_TAGS" ]; then
          echo "üìå Semver tags:"
          echo "$SEMVER_TAGS" | sed 's/^/  /'
          echo ""
        fi
        
        if [ -n "$SHA_TAGS" ]; then
          echo "üîñ SHA tags:"
          echo "$SHA_TAGS" | sed 's/^/  /'
          echo ""
        fi
        
        if [ -n "$OTHER_TAGS" ]; then
          echo "üè∑Ô∏è  Other tags:"
          echo "$OTHER_TAGS" | sed 's/^/  /'
          echo ""
        fi
