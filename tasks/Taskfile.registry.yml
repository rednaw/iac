# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:
  map:
    desc: "Show all tags with SHA, created, description (registry-only, config labels)"
    silent: true
    cmds:
      - |
        set -euo pipefail

        REPO="{{.CLI_ARGS}}"
        if [ -z "$REPO" ]; then
          echo "‚ùå Error: Repository not specified"
          echo ""
          echo "Usage:"
          echo "  task registry:map -- <REPO>"
          echo ""
          echo "Example:"
          echo "  task registry:map -- registry.rednaw.nl/rednaw/hello-world"
          exit 1
        fi

        echo "üì¶ All tags for $REPO"
        echo ""

        TAGS=$(crane ls "$REPO" 2>/dev/null | sort -r || true)
        if [ -z "$TAGS" ]; then
          echo "‚ÑπÔ∏è  No tags found"
          exit 0
        fi

        # Print header
        echo -e "TAG\tSHA\tCREATED\tDESCRIPTION"

        for TAG in $TAGS; do
          CONFIG_JSON=$(crane config "$REPO:$TAG" 2>/dev/null || true)

          DESCRIPTION=""
          REVISION=""
          CREATED=""

          if [ -n "$CONFIG_JSON" ]; then
            DESCRIPTION=$(echo "$CONFIG_JSON" | jq -r '.config.Labels["org.opencontainers.image.description"] // ""')
            REVISION=$(echo "$CONFIG_JSON" | jq -r '.config.Labels["org.opencontainers.image.revision"] // ""')
            CREATED=$(echo "$CONFIG_JSON" | jq -r '.config.Labels["org.opencontainers.image.created"] // ""' | cut -d'+' -f1)
          fi

          SHORT_SHA=""
          [ -n "$REVISION" ] && SHORT_SHA="${REVISION:0:7}"

          # truncate description for readability
          [ ${#DESCRIPTION} -gt 38 ] && DESCRIPTION="${DESCRIPTION:0:38}"

          # always output 4 fields
          echo -e "${TAG}\t${SHORT_SHA}\t${CREATED}\t${DESCRIPTION}"
        done | column -t -s $'\t'
