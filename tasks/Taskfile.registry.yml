# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:
  overview:
    desc: "List registry tags (TAG, CREATED, DESCRIPTION) for all repos"
    silent: true
    cmds:
      - |
        set -euo pipefail

        REGISTRY="registry.rednaw.nl"
        REPOS=$(crane catalog "$REGISTRY" 2>/dev/null || true)
        if [ -z "$REPOS" ]; then
          echo "⚠️  No repositories found (or access denied)"
          echo "   Use the devcontainer to interact with the registry (auth is configured automatically)."
          exit 0
        fi

        for REPO in $REPOS; do
          TAGS=$(crane ls "$REGISTRY/$REPO" 2>/dev/null | sort -r || true)
          if [ -z "$TAGS" ]; then
            echo "  ℹ️  No tags"
            continue
          fi
          printf "  %-16s %-20s %-40s\n" "TAG" "CREATED" "DESCRIPTION"
          printf "  %-16s %-20s %-40s\n" "---" "-------" "-----------"
          for TAG in $TAGS; do
            CONFIG=$(crane config "$REGISTRY/$REPO:$TAG" 2>/dev/null || true)
            CREATED=""
            DESCRIPTION=""
            if [ -n "$CONFIG" ]; then
              CREATED=$(echo "$CONFIG" | jq -r '.config.Labels["org.opencontainers.image.created"] // ""' | cut -d'+' -f1)
              DESCRIPTION=$(echo "$CONFIG" | jq -r '.config.Labels["org.opencontainers.image.description"] // ""')
            fi
            # truncate for readability
            [ ${#DESCRIPTION} -gt 38 ] && DESCRIPTION="${DESCRIPTION:0:38}"
            printf "  %-16s %-20s %-40s\n" \
              "$TAG" "$CREATED" "$DESCRIPTION"
          done
          echo
        done

