# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:
  keygen:
    desc: Generate age key pair
    silent: true
    cmds:
      - |
        # Create directory if it doesn't exist
        mkdir -p "{{.SOPS_CONFIG_DIR}}"
        chmod 700 "{{.SOPS_CONFIG_DIR}}"
        
        PRIV_KEY="{{.SOPS_KEY_FILE}}"
        PUB_KEY="{{.SOPS_KEY_PUB}}"
        
        # Check if key pair already exists
        if [ -f "$PRIV_KEY" ] && [ -f "$PUB_KEY" ]; then
          echo "âœ… Key pair ready for {{.USERNAME}}"
          exit 0
        fi
        
        # Clean up partial keys
        [ -e "$PRIV_KEY" ] && rm -f "$PRIV_KEY"
        
        echo "ğŸ”‘ Generating age key pair for {{.USERNAME}}..."
        
        # Generate in standard location
        age-keygen -o "$PRIV_KEY"
        chmod 600 "$PRIV_KEY"
        age-keygen -y "$PRIV_KEY" > "$PUB_KEY"
        
        echo ""
        echo "âœ… Key pair generated successfully!"
        echo "   ğŸ”’ Private key: $PRIV_KEY (NOT in Git)"
        echo "   ğŸ“ Public key:  $PUB_KEY (commit to Git)"

  generate-sops-config:
    desc: Generate .sops.yaml from public keys
    silent: true
    cmds:
      - |
        echo "ğŸ”§ Generating .sops.yaml from public keys..."
        {
          echo "creation_rules:"
          echo '  - path_regex: .*\.(json|yml|yaml|env)(\.enc)?$'
          printf "    age: "
          first=1
          for pub in secrets/sops-key-*.pub; do
            if [ -f "$pub" ]; then
              if [ $first -eq 1 ]; then
                tr -d '\n' < "$pub"
                first=0
              else
                printf ","
                tr -d '\n' < "$pub"
              fi
            fi
          done
          printf "\n"
        } > .sops.yaml
      - echo "âœ… Generated .sops.yaml"

  decrypt:
    desc: Decrypt secrets for editing
    silent: true
    cmds:
      - |
        echo "ğŸ”“ Decrypting secrets..."
        
        if [ ! -f "{{.SOPS_KEY_FILE}}" ]; then
          echo "âŒ SOPS key file not found!"
          echo ""
          echo "   Expected location: \"{{.SOPS_KEY_FILE}}\""
          echo "   Generate a key pair with: task secrets:keygen"
          exit 1
        fi
        
        if ! SOPS_AGE_KEY_FILE="{{.SOPS_KEY_FILE}}" sops -d --input-type yaml --output-type yaml secrets/infrastructure-secrets.yml.enc > secrets/infrastructure-secrets.yml 2>/dev/null; then
          echo "âŒ Decryption failed. Possible causes:"
          echo "   1. Wrong SOPS key file: \"{{.SOPS_KEY_FILE}}\""
          echo "   2. Encrypted file is corrupted: secrets/infrastructure-secrets.yml.enc"
          echo "   3. Key file format is invalid"
          echo "   4. Your public key is not included in the encrypted file"
          echo ""
          echo "   To fix:"
          echo "   - Verify \"{{.SOPS_KEY_FILE}}\" is your correct key file"
          echo "   - If you're a new team member and your key isn't included yet:"
          echo "     * Ensure you've run 'task secrets:keygen' and committed your public key"
          echo "     * An existing team member needs to re-encrypt: task secrets:decrypt && task secrets:encrypt"
          echo "     * After re-encryption, your key will be included and you can decrypt"
          echo "   - If you have the unencrypted file, you can encrypt it yourself:"
          echo "     * task secrets:encrypt (will include all public keys automatically)"
          exit 1
        fi
      - echo "âœ… Secrets decrypted to secrets/infrastructure-secrets.yml"

  encrypt:
    desc: Encrypt secrets
    deps: [keygen, generate-sops-config]
    preconditions:
      - test -f secrets/infrastructure-secrets.yml
    silent: true
    cmds:
      - |
        echo "ğŸ”’ Encrypting secrets..."
        
        if [ ! -f "{{.SOPS_KEY_FILE}}" ]; then
          echo "âŒ SOPS key file not found! Run 'task secrets:keygen' first."
          exit 1
        fi
        
        SOPS_AGE_KEY_FILE="{{.SOPS_KEY_FILE}}" sops --encrypt --input-type yaml secrets/infrastructure-secrets.yml > secrets/infrastructure-secrets.yml.enc
        echo "âœ… Secrets encrypted to secrets/infrastructure-secrets.yml.enc"

