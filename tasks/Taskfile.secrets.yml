# yaml-language-server: $schema=https://taskfile.dev/schema.json
#
# Secrets management - key generation and SOPS configuration
#
# With VS Code SOPS extension installed, encrypted files are edited transparently.
# No manual encrypt/decrypt needed.
#
version: '3'

vars:
  SECRETS_DIR: '{{.TASKFILE_DIR}}/../secrets'
  SOPS_CONFIG_DIR: '{{.HOME}}/.config/sops/age'
  SOPS_KEY_FILE: '{{.SOPS_CONFIG_DIR}}/keys.txt'
  SOPS_KEY_PUB: '{{.SECRETS_DIR}}/sops-key-{{.USER}}.pub'
  RECIPIENTS:
    sh: |
      DIR="{{.TASKFILE_DIR}}/../secrets"
      for pub in "$DIR"/sops-key-*.pub; do
        if [ -f "$pub" ]; then cat "$pub" | tr -d '\n'; echo ","; fi
      done | tr -d '\n' | sed 's/,$//'

tasks:
  keygen:
    desc: Generate age key pair for SOPS encryption
    silent: true
    cmds:
      - |
        mkdir -p "{{.SOPS_CONFIG_DIR}}"
        chmod 700 "{{.SOPS_CONFIG_DIR}}"
        
        PRIV_KEY="{{.SOPS_KEY_FILE}}"
        PUB_KEY="{{.SOPS_KEY_PUB}}"
        
        if [ -f "$PRIV_KEY" ] && [ -f "$PUB_KEY" ]; then
          echo "‚úÖ Key pair ready for {{.USER}}"
          exit 0
        fi
        
        [ -e "$PRIV_KEY" ] && rm -f "$PRIV_KEY"
        
        echo "üîë Generating age key pair for {{.USER}}..."
        age-keygen -o "$PRIV_KEY"
        chmod 600 "$PRIV_KEY"
        age-keygen -y "$PRIV_KEY" > "$PUB_KEY"
        
        echo ""
        echo "‚úÖ Key pair generated!"
        echo "   üîí Private: $PRIV_KEY"
        echo "   üìù Public:  $PUB_KEY (commit this)"

  generate-sops-config:
    desc: Generate .sops.yaml configuration from public keys
    silent: true
    cmds:
      - |
        echo "üîß Generating .sops.yaml from public keys..."
        cat > .sops.yaml << 'EOF'
        # SOPS configuration for transparent encryption
        # Used by VS Code SOPS extension and CLI
        #
        # Files matched by these rules are encrypted at rest.
        # With VS Code extension: open ‚Üí decrypt, save ‚Üí encrypt (transparent)
        # With CLI: sops <file> opens decrypted in editor
        
        creation_rules:
          # Infrastructure secrets (YAML format)
          - path_regex: secrets/infrastructure-secrets\.yml$
            age: {{.RECIPIENTS}}
        
          # Application secrets (YAML format)
          - path_regex: secrets\.yml$
            age: {{.RECIPIENTS}}
        EOF
        echo "‚úÖ Generated .sops.yaml"
        echo ""
        echo "üìù Files covered by encryption rules:"
        echo "   - iac/secrets/infrastructure-secrets.yml"
        echo "   - */secrets.yml (application secrets)"
