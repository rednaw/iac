# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:
  check-status:
    desc: Check if servers are up and accessible (checks both dev and prod)
    silent: true
    cmds:
      - |
        for WORKSPACE in dev prod; do
          echo "ðŸ“‹ Checking $WORKSPACE environment..."
          HOSTNAME=$(task hostkeys:hostname -- "$WORKSPACE")
          if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new -o BatchMode=yes "ubuntu@$HOSTNAME" "echo 'Server is up'" >/dev/null 2>&1; then
            echo "  âœ… Server is up and ubuntu user is accessible ($HOSTNAME)"
          elif ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new -o BatchMode=yes "root@$HOSTNAME" "echo 'Server is up'" >/dev/null 2>&1; then
            echo "  âœ… Server is up ($HOSTNAME)"
            echo "  âš ï¸  Root access available, run 'task ansible:bootstrap -- $WORKSPACE' to set up ubuntu user"
          else
            echo "  âŒ Server is not reachable ($HOSTNAME)"
            ERR=$(ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=accept-new -o BatchMode=yes "ubuntu@$HOSTNAME" "echo" 2>&1) || true
            echo "  â”‚ ${ERR//$'\n'/$'\n  â”‚ '}"
          fi
          echo ""
        done

  list-hetzner-keys:
    desc: List Hetzner SSH keys with IDs
    silent: true
    cmds:
      - |
        echo "ðŸ”‘ Listing Hetzner SSH keys..."
        echo ""
        hcloud ssh-key list -o columns=name,id
        echo ""
        echo "ðŸ’¡ Use the 'ID' column for secrets/infrastructure-secrets.yml (ssh_keys: [\"ID\", ...])"

