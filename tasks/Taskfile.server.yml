# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:
  check-status:
    desc: Check if servers are up and accessible (checks both dev and prod)
    silent: true
    cmds:
      - |
        for WORKSPACE in dev prod; do
          echo "ðŸ“‹ Checking $WORKSPACE environment..."
          HOSTNAME=$(task hostkeys:hostname -- "$WORKSPACE")
          if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new -o BatchMode=yes "ubuntu@$HOSTNAME" "echo 'Server is up'" >/dev/null 2>&1; then
            echo "  âœ… Server is up and ubuntu user is accessible ($HOSTNAME)"
          elif ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new -o BatchMode=yes "root@$HOSTNAME" "echo 'Server is up'" >/dev/null 2>&1; then
            echo "  âœ… Server is up ($HOSTNAME)"
            echo "  âš ï¸  Root access available, run 'task ansible:bootstrap -- $WORKSPACE' to set up ubuntu user"
          else
            echo "  âŒ Server is not reachable ($HOSTNAME)"
          fi
          echo ""
        done

  list-hetzner-keys:
    desc: List Hetzner SSH keys with IDs
    silent: true
    cmds:
      - |
        echo "ðŸ”‘ Listing Hetzner SSH keys..."
        echo ""
        hcloud ssh-key list -o columns=name,id
        echo ""
        echo "ðŸ’¡ Use the 'ID' column for secrets/infrastructure-secrets.yml (ssh_keys: [\"ID\", ...])"

  setup-remote-cursor:
    desc: Add dev and prod servers to ~/.ssh/config for Cursor Remote-SSH
    silent: true
    cmds:
      - |
        echo "ðŸ”§ Updating SSH config for dev and prod servers..."
        for WORKSPACE in dev prod; do
          HOSTNAME=$(task hostkeys:hostname -- "$WORKSPACE")
          if grep -q "^Host $WORKSPACE$" ~/.ssh/config 2>/dev/null; then
            if [ "$(uname -s)" = "Darwin" ]; then
              sed -i '' "/^Host $WORKSPACE$/,/^Host /s|^  HostName .*|  HostName $HOSTNAME|" ~/.ssh/config
            else
              sed -i "/^Host $WORKSPACE$/,/^Host /s|^  HostName .*|  HostName $HOSTNAME|" ~/.ssh/config
            fi
            echo "  âœ… Updated $WORKSPACE ($HOSTNAME)"
          else
            {
              echo ""
              echo "Host $WORKSPACE"
              echo "  HostName $HOSTNAME"
              echo "  User ubuntu"
              echo "  IdentityFile ~/.ssh/id_rsa"
              echo "  IdentitiesOnly yes"
              echo "  StrictHostKeyChecking accept-new"
            } >> ~/.ssh/config
            echo "  âœ… Added $WORKSPACE ($HOSTNAME)"
          fi
        done
        chmod 600 ~/.ssh/config
