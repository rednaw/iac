# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:
  check-status:
    desc: Check if servers are up and accessible (checks both dev and prod)
    silent: true
    cmds:
      - |
        for WORKSPACE in dev prod; do
          echo "ðŸ“‹ Checking $WORKSPACE environment..."
          HOSTNAME=$(task hostkeys:hostname -- "$WORKSPACE")
          if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new -o BatchMode=yes "ubuntu@$HOSTNAME" "echo 'Server is up'" >/dev/null 2>&1; then
            echo "  âœ… Server is up and ubuntu user is accessible ($HOSTNAME)"
          elif ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new -o BatchMode=yes "root@$HOSTNAME" "echo 'Server is up'" >/dev/null 2>&1; then
            echo "  âœ… Server is up ($HOSTNAME)"
            echo "  âš ï¸  Root access available, run 'task ansible:bootstrap -- $WORKSPACE' to set up ubuntu user"
          else
            echo "  âŒ Server is not reachable ($HOSTNAME)"
            ERR=$(ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=accept-new -o BatchMode=yes "ubuntu@$HOSTNAME" "echo" 2>&1) || true
            echo "  â”‚ ${ERR//$'\n'/$'\n  â”‚ '}"
          fi
          echo ""
        done

  list-hetzner-keys:
    desc: List Hetzner SSH keys with IDs
    silent: true
    cmds:
      - |
        echo "ðŸ”‘ Listing Hetzner SSH keys..."
        echo ""
        hcloud ssh-key list -o columns=name,id
        echo ""
        echo "ðŸ’¡ Use the 'ID' column for secrets/infrastructure-secrets.yml (ssh_keys: [\"ID\", ...])"

  setup-remote-cursor:
    desc: "Write dev and prod to ~/.ssh/config.d/iac-admin (fully managed). Add Include config.d/iac-admin to ~/.ssh/config to use."
    cmds:
      - bash scripts/setup-remote-cursor.sh

  tunnel-start:
    desc: "Start SSH tunnel to workspace for admin UIs. Use: task server:tunnel-start -- dev|prod"
    vars:
      WORKSPACE: "{{.CLI_ARGS}}"
    preconditions:
      - sh: '[ -n "{{.WORKSPACE}}" ]'
        msg: "Workspace required. Usage: task server:tunnel-start -- <dev|prod>"
      - sh: '[ "{{.WORKSPACE}}" = "dev" ] || [ "{{.WORKSPACE}}" = "prod" ]'
        msg: "Invalid workspace. Use: dev or prod"
    cmds:
      - |
        HOSTNAME=$(task hostkeys:hostname -- "{{.WORKSPACE}}")
        if pgrep -f "ssh.*-L 5080:localhost:5080.*ubuntu@$HOSTNAME" >/dev/null 2>&1; then
          echo "Tunnel to {{.WORKSPACE}} already running."
          echo "  Traefik Dashboard: http://localhost:8080/dashboard/"
          echo "  OpenObserve:        http://localhost:5080/"
          echo "  Registry:           http://localhost:5000"
          exit 0
        fi
        ssh -f -N -L 5080:localhost:5080 -L 5000:localhost:5000 -L 8080:localhost:8080 -o StrictHostKeyChecking=accept-new "ubuntu@$HOSTNAME" || { echo "Failed to start tunnel. Run 'task server:setup-remote-cursor' first?"; exit 1; }
        echo "Tunnel to {{.WORKSPACE}} started."
        echo "  Traefik Dashboard: http://localhost:8080/dashboard/"
        echo "  OpenObserve:        http://localhost:5080/"
        echo "  Registry:           http://localhost:5000"
        echo "Stop: task server:tunnel-stop -- {{.WORKSPACE}}"

  tunnel-stop:
    desc: "Stop SSH tunnel for workspace. Use: task server:tunnel-stop -- dev|prod"
    vars:
      WORKSPACE: "{{.CLI_ARGS}}"
    preconditions:
      - sh: '[ -n "{{.WORKSPACE}}" ]'
        msg: "Workspace required. Usage: task server:tunnel-stop -- <dev|prod>"
      - sh: '[ "{{.WORKSPACE}}" = "dev" ] || [ "{{.WORKSPACE}}" = "prod" ]'
        msg: "Invalid workspace. Use: dev or prod"
    cmds:
      - |
        HOSTNAME=$(task hostkeys:hostname -- "{{.WORKSPACE}}")
        PIDS=$(pgrep -f "ssh.*-L 5080:localhost:5080.*ubuntu@$HOSTNAME" 2>/dev/null) || true
        if [ -z "$PIDS" ]; then
          echo "No tunnel to {{.WORKSPACE}} running."
        else
          echo "$PIDS" | xargs kill 2>/dev/null || true
          echo "Tunnel to {{.WORKSPACE}} stopped."
        fi
