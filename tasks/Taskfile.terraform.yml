# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:
  init:
    desc: "Initialize Terraform (use: task terraform:init -- dev or -- prod)"
    dir: terraform
    silent: true
    vars:
      WORKSPACE: "{{.CLI_ARGS}}"
    preconditions:
      - sh: '[ -n "{{.WORKSPACE}}" ]'
        msg: "Workspace required. Usage: task terraform:init -- <dev|prod>"
      - sh: '[ "{{.WORKSPACE}}" = "dev" ] || [ "{{.WORKSPACE}}" = "prod" ]'
        msg: "Invalid workspace '{{.WORKSPACE}}'. Use: dev or prod"
      - sh: test -f "{{.SOPS_KEY_FILE}}"
        msg: "SOPS key file not found. Run 'task secrets:keygen' first."
    cmds:
      - |
        echo "üöÄ Initializing Terraform for workspace: platform-{{.WORKSPACE}}..."
        SOPS_AGE_KEY_FILE="{{.SOPS_KEY_FILE}}" terraform init -reconfigure
        if ! terraform workspace select "{{.WORKSPACE}}" 2>/dev/null; then
          echo ""
          echo "Workspace 'platform-{{.WORKSPACE}}' not found in Terraform Cloud"
          echo ""
          echo "Create the workspace first in Terraform Cloud:"
          echo "  1. Go to Terraform Cloud ‚Üí Organization 'rednaw'"
          echo "  2. Create workspace: 'platform-{{.WORKSPACE}}'"
          echo ""
          echo "See README.md for detailed setup instructions."
          exit 1
        fi

  plan:
    desc: "Plan Terraform changes (use: task terraform:plan -- dev or -- prod)"
    dir: terraform
    silent: true
    vars:
      WORKSPACE: "{{.CLI_ARGS}}"
    preconditions:
      - sh: '[ -n "{{.WORKSPACE}}" ]'
        msg: "Workspace required. Usage: task terraform:plan -- <dev|prod>"
      - sh: '[ "{{.WORKSPACE}}" = "dev" ] || [ "{{.WORKSPACE}}" = "prod" ]'
        msg: "Invalid workspace '{{.WORKSPACE}}'. Use: dev or prod"
      - sh: test -f "{{.SOPS_KEY_FILE}}"
        msg: "SOPS key file not found. Run 'task secrets:keygen' first."
    cmds:
      - |
        echo "üìã Planning Terraform changes for workspace: platform-{{.WORKSPACE}}..."
        terraform workspace select "{{.WORKSPACE}}"
        SOPS_AGE_KEY_FILE="{{.SOPS_KEY_FILE}}" terraform plan

  apply:
    desc: "Apply Terraform changes (use: task terraform:apply -- dev or -- prod)"
    dir: terraform
    silent: true
    vars:
      WORKSPACE: "{{.CLI_ARGS}}"
    preconditions:
      - sh: '[ -n "{{.WORKSPACE}}" ]'
        msg: "Workspace required. Usage: task terraform:apply -- <dev|prod>"
      - sh: '[ "{{.WORKSPACE}}" = "dev" ] || [ "{{.WORKSPACE}}" = "prod" ]'
        msg: "Invalid workspace '{{.WORKSPACE}}'. Use: dev or prod"
      - sh: test -f "{{.SOPS_KEY_FILE}}"
        msg: "SOPS key file not found. Run 'task secrets:keygen' first."
    cmds:
      - |
        echo "‚ú® Applying Terraform changes to workspace: platform-{{.WORKSPACE}}"
        terraform workspace select "{{.WORKSPACE}}"
        echo "üîë Removing old host key for workspace from known_hosts..."
        task hostkeys:prepare -- "{{.WORKSPACE}}"
        SOPS_AGE_KEY_FILE="{{.SOPS_KEY_FILE}}" terraform apply
        echo "üîë Accepting new host key..."
        HOSTNAME=$(task hostkeys:hostname -- "{{.WORKSPACE}}")
        ssh -o StrictHostKeyChecking=accept-new -o ConnectTimeout=5 -o BatchMode=yes "ubuntu@${HOSTNAME}" "echo" >/dev/null 2>&1 || true

  destroy:
    desc: "Destroy Terraform resources (use: task terraform:destroy -- dev or -- prod)"
    dir: terraform
    silent: true
    vars:
      WORKSPACE: "{{.CLI_ARGS}}"
    preconditions:
      - sh: '[ -n "{{.WORKSPACE}}" ]'
        msg: "Workspace required. Usage: task terraform:destroy -- <dev|prod>"
      - sh: '[ "{{.WORKSPACE}}" = "dev" ] || [ "{{.WORKSPACE}}" = "prod" ]'
        msg: "Invalid workspace '{{.WORKSPACE}}'. Use: dev or prod"
      - sh: test -f "{{.SOPS_KEY_FILE}}"
        msg: "SOPS key file not found. Run 'task secrets:keygen' first."
    cmds:
      - |
        echo "‚ö†Ô∏è  WARNING: This will DESTROY all resources in workspace: platform-{{.WORKSPACE}}"
        echo "Terraform will ask for confirmation..."
        echo ""
        terraform workspace select "{{.WORKSPACE}}"
        SOPS_AGE_KEY_FILE="{{.SOPS_KEY_FILE}}" terraform destroy
        echo "üßπ Cleaning server host key from known_hosts..."
        task hostkeys:prepare -- "{{.WORKSPACE}}"
        echo "‚úÖ Host key removed"

  output:
    desc: "Show Terraform outputs (use: task terraform:output -- dev or -- prod)"
    dir: terraform
    vars:
      WORKSPACE: "{{.CLI_ARGS}}"
    preconditions:
      - sh: '[ -n "{{.WORKSPACE}}" ]'
        msg: "Workspace required. Usage: task terraform:output -- <dev|prod>"
      - sh: '[ "{{.WORKSPACE}}" = "dev" ] || [ "{{.WORKSPACE}}" = "prod" ]'
        msg: "Invalid workspace '{{.WORKSPACE}}'. Use: dev or prod"
    cmds:
      - |
        terraform workspace select "{{.WORKSPACE}}"
        echo "üì§ Getting Terraform outputs for workspace: platform-{{.WORKSPACE}}..."
        terraform output
