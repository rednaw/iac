# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:
  login:
    desc: Authenticate with Terraform Cloud
    dir: terraform
    cmds:
      - echo "üîê Authenticating with Terraform Cloud..."
      - cmd: terraform login
        silent: true

  init:
    desc: "Initialize Terraform (use: task terraform:init -- dev or -- prod)"
    dir: terraform
    silent: true
    cmds:
      - |
        WORKSPACE=$(../scripts/validate-workspace.sh terraform init "{{.CLI_ARGS}}")
        echo "üöÄ Initializing Terraform for workspace: giftfinder-$WORKSPACE..."
        if [ ! -f "{{.SOPS_KEY_FILE}}" ]; then
          echo "‚ùå SOPS key file not found! Run 'task secrets:keygen' first."
          exit 1
        fi
        # Initialize backend first (connects to Terraform Cloud)
        # Use -reconfigure for new workspaces or when backend config changed
        SOPS_AGE_KEY_FILE="{{.SOPS_KEY_FILE}}" terraform init -reconfigure
        # Then select workspace (must exist in Terraform Cloud)
        # With prefix backend, select just the workspace name (Terraform adds prefix automatically)
        if ! terraform workspace select "$WORKSPACE" 2>/dev/null; then
          echo ""
          echo "‚ùå Error: Workspace 'giftfinder-$WORKSPACE' not found in Terraform Cloud"
          echo ""
          echo "Create the workspace first in Terraform Cloud:"
          echo "  1. Go to Terraform Cloud ‚Üí Organization 'milledoni'"
          echo "  2. Create workspace: 'giftfinder-$WORKSPACE'"
          echo "     (Environment '$WORKSPACE' will be automatically derived from workspace name)"
          echo ""
          echo "See README.md for detailed setup instructions."
          exit 1
        fi

  plan:
    desc: "Plan Terraform changes (use: task terraform:plan -- dev or -- prod)"
    dir: terraform
    silent: true
    cmds:
      - |
        WORKSPACE=$(../scripts/validate-workspace.sh terraform plan "{{.CLI_ARGS}}")
        echo "üìã Planning Terraform changes for workspace: giftfinder-$WORKSPACE..."
        if [ ! -f "{{.SOPS_KEY_FILE}}" ]; then
          echo "‚ùå SOPS key file not found! Run 'task secrets:keygen' first."
          exit 1
        fi
        terraform workspace select "$WORKSPACE"
        SOPS_AGE_KEY_FILE="{{.SOPS_KEY_FILE}}" terraform plan

  apply:
    desc: "Apply Terraform changes (use: task terraform:apply -- dev or -- prod)"
    dir: terraform
    silent: true
    cmds:
      - |
        WORKSPACE=$(../scripts/validate-workspace.sh terraform apply "{{.CLI_ARGS}}")
        echo "‚ú® Applying Terraform changes to workspace: giftfinder-$WORKSPACE"
        if [ ! -f "{{.SOPS_KEY_FILE}}" ]; then
          echo "‚ùå SOPS key file not found! Run 'task secrets:keygen' first."
          exit 1
        fi
        terraform workspace select "$WORKSPACE"
        echo "üîë Removing old host key for workspace from known_hosts..."
        task hostkeys:prepare -- "$WORKSPACE"
        SOPS_AGE_KEY_FILE="{{.SOPS_KEY_FILE}}" terraform apply
        echo "üîë Accepting new host key..."
        HOSTNAME=$(task hostkeys:hostname -- "$WORKSPACE")
        ssh -o StrictHostKeyChecking=accept-new -o ConnectTimeout=5 -o BatchMode=yes "ubuntu@${HOSTNAME}" "echo" >/dev/null 2>&1 || true

  destroy:
    desc: "Destroy Terraform resources (use: task terraform:destroy -- dev or -- prod)"
    dir: terraform
    silent: true
    cmds:
      - |
        WORKSPACE=$(../scripts/validate-workspace.sh terraform destroy "{{.CLI_ARGS}}")
        echo "‚ö†Ô∏è  WARNING: This will DESTROY all resources in workspace: giftfinder-$WORKSPACE"
        echo "Terraform will ask for confirmation..."
        echo ""
        terraform workspace select "$WORKSPACE"
        if [ ! -f "{{.SOPS_KEY_FILE}}" ]; then
          echo "‚ùå SOPS key file not found! Run 'task secrets:keygen' first."
          exit 1
        fi
        SOPS_AGE_KEY_FILE="{{.SOPS_KEY_FILE}}" terraform destroy
        echo "üßπ Cleaning server host key from known_hosts..."
        task hostkeys:prepare -- "$WORKSPACE"
        echo "‚úÖ Host key removed"

  output:
    desc: "Show Terraform outputs (use: task terraform:output -- dev or -- prod)"
    dir: terraform
    cmds:
      - |
        WORKSPACE=$(../scripts/validate-workspace.sh terraform output "{{.CLI_ARGS}}")
        terraform workspace select "$WORKSPACE"
        echo "üì§ Getting Terraform outputs for workspace: giftfinder-$WORKSPACE..."
        terraform output
