# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

tasks:
  run:
    desc: Run all tests (validate, security scan, Ansible lint & syntax, taskfiles)
    silent: true
    cmds:
      - |
        echo "ğŸ§ª Running test suite..."
        echo ""
        VALIDATE_RESULT=0
        SECURITY_RESULT=0
        ANSIBLE_LINT_RESULT=0
        ANSIBLE_SYNTAX_RESULT=0
        TASKFILE_RESULT=0
        task test:terraform:validate || VALIDATE_RESULT=$?
        task test:terraform:security || SECURITY_RESULT=$?
        task test:ansible:lint || ANSIBLE_LINT_RESULT=$?
        task test:ansible:syntax || ANSIBLE_SYNTAX_RESULT=$?
        task test:taskfiles || TASKFILE_RESULT=$?
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Test Results:"
        if [ $VALIDATE_RESULT -eq 0 ]; then
          echo "  âœ… Terraform Validation: PASSED"
        else
          echo "  âŒ Terraform Validation: FAILED"
        fi
        if [ $SECURITY_RESULT -eq 0 ]; then
          echo "  âœ… Terraform Security:   PASSED"
        else
          echo "  âŒ Terraform Security:   FAILED"
        fi
        if [ $ANSIBLE_LINT_RESULT -eq 0 ]; then
          echo "  âœ… Ansible Lint:         PASSED"
        else
          echo "  âŒ Ansible Lint:         FAILED"
        fi
        if [ $ANSIBLE_SYNTAX_RESULT -eq 0 ]; then
          echo "  âœ… Ansible Syntax:       PASSED"
        else
          echo "  âŒ Ansible Syntax:       FAILED"
        fi
        if [ $TASKFILE_RESULT -eq 0 ]; then
          echo "  âœ… Taskfiles:            PASSED"
        else
          echo "  âŒ Taskfiles:            FAILED"
        fi
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        if [ $VALIDATE_RESULT -eq 0 ] && [ $SECURITY_RESULT -eq 0 ] && [ $ANSIBLE_LINT_RESULT -eq 0 ] && [ $ANSIBLE_SYNTAX_RESULT -eq 0 ] && [ $TASKFILE_RESULT -eq 0 ]; then
          echo ""
          echo "ğŸ‰ All tests passed!"
          exit 0
        else
          echo ""
          echo "âŒ Some tests failed"
          exit 1
        fi

  terraform:validate:
    desc: Validate Terraform configuration
    silent: true
    dir: terraform
    cmds:
      - |
        echo "ğŸ” Validating Terraform configuration..."
        if [ ! -f "{{.SOPS_KEY_FILE}}" ]; then
          echo "âŒ SOPS key file \"{{.SOPS_KEY_FILE}}\" not found. Run 'task secrets:keygen' first."
          exit 1
        fi
        if ! SOPS_AGE_KEY_FILE="{{.SOPS_KEY_FILE}}" terraform init -backend=false >/dev/null 2>&1; then
          echo "âŒ Terraform initialization failed"
          exit 1
        fi
        if ! SOPS_AGE_KEY_FILE="{{.SOPS_KEY_FILE}}" terraform validate; then
          echo "âŒ Terraform validation failed"
          exit 1
        fi
      - echo "âœ… Terraform validation passed"

  terraform:security:
    desc: Run Terraform security scan (tfsec)
    dir: terraform
    silent: true
    cmds:
      - |
        echo ""
        echo "ğŸ”’ Running security scan with tfsec..."
        tfsec . --minimum-severity MEDIUM || (echo "âŒ Security scan found issues" && exit 1)
      - echo "âœ… Security scan passed"

  ansible:lint:
    desc: Lint Ansible playbooks (ansible-lint)
    dir: ansible
    silent: true
    cmds:
      - |
        echo ""
        echo "ğŸ” Linting Ansible playbooks..."
        ansible-lint playbooks/site.yml playbooks/bootstrap.yml || (echo "âŒ Ansible linting found issues" && exit 1)
      - echo "âœ… Ansible linting passed"

  ansible:syntax:
    desc: Validate Ansible playbook syntax
    dir: ansible
    silent: true
    cmds:
      - |
        echo ""
        echo "ğŸ” Validating Ansible playbook syntax..."
        ansible-playbook --syntax-check playbooks/site.yml -i localhost, 2>/dev/null || (echo "âŒ site.yml syntax check failed" && exit 1)
        ansible-playbook --syntax-check playbooks/bootstrap.yml -i localhost, 2>/dev/null || (echo "âŒ bootstrap.yml syntax check failed" && exit 1)
      - echo "âœ… Ansible syntax validation passed"

  taskfiles:
    desc: Validate embedded scripts in Taskfiles
    silent: true
    cmds:
      - python3 scripts/validate-taskfiles.py
