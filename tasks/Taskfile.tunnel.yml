# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

# SSH tunnel for admin UIs (Traefik, OpenObserve). Run manually when needed.

tasks:
  start:
    desc: "Start SSH tunnel to workspace for admin UIs. Use: task tunnel:start -- dev|prod"
    silent: true
    vars:
      WORKSPACE: "{{.CLI_ARGS}}"
    preconditions:
      - sh: '[ -n "{{.WORKSPACE}}" ]'
        msg: "Workspace required. Usage: task tunnel:start -- <dev|prod>"
      - sh: '[ "{{.WORKSPACE}}" = "dev" ] || [ "{{.WORKSPACE}}" = "prod" ]'
        msg: "Invalid workspace. Use: dev or prod"
    cmds:
      - |
        if pgrep -f "ssh.*-f.*-N.*{{.WORKSPACE}}" >/dev/null 2>&1; then
          echo "Tunnel to {{.WORKSPACE}} already running."
          echo "  Traefik Dashboard: http://localhost:8080/dashboard/"
          echo "  OpenObserve:       http://localhost:5080/"
          exit 0
        fi
        ssh -f -N "{{.WORKSPACE}}" || { echo "Failed to start tunnel."; exit 1; }
        echo "Tunnel to {{.WORKSPACE}} started (uses Host {{.WORKSPACE}} from SSH config)."
        echo "  Traefik Dashboard: http://localhost:8080/dashboard/"
        echo "  OpenObserve:       http://localhost:5080/"
        echo "  Stop: task tunnel:stop -- {{.WORKSPACE}}"

  stop:
    desc: "Stop SSH tunnel for workspace. Use: task tunnel:stop -- dev|prod"
    silent: true
    vars:
      WORKSPACE: "{{.CLI_ARGS}}"
    preconditions:
      - sh: '[ -n "{{.WORKSPACE}}" ]'
        msg: "Workspace required. Usage: task tunnel:stop -- <dev|prod>"
      - sh: '[ "{{.WORKSPACE}}" = "dev" ] || [ "{{.WORKSPACE}}" = "prod" ]'
        msg: "Invalid workspace. Use: dev or prod"
    cmds:
      - |
        PIDS=$(pgrep -f "ssh.*-f.*-N.*{{.WORKSPACE}}" 2>/dev/null) || true
        if [ -z "$PIDS" ]; then
          echo "No tunnel to {{.WORKSPACE}} running."
        else
          echo "$PIDS" | xargs kill 2>/dev/null || true
          echo "Tunnel to {{.WORKSPACE}} stopped."
        fi
